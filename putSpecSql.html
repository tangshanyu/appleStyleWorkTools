<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL 參數替換工具</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <div class="container">
        <div class="header theme-blue">
            <h1>SQL 參數替換工具</h1>
            <p>自動掃描並替換 SQL 語句中的參數佔位符</p>
        </div>
        
        <nav class="nav">
            <a href="index.html">🏠 回首頁</a>
            <a href="changeQuestionMark.html">❓ 問號轉換</a>
            <a href="addSbAppend.html">☕ Java 轉換</a>
        </nav>
        
        <div class="content">
            <div class="alert alert-info">
                <strong>✨ 使用說明：</strong>
                輸入包含 'Parm1', 'Parm2' 等參數的 SQL 語句，點擊「掃描參數」後會自動識別參數並提供輸入欄位，填入實際值後點擊「執行替換」即可生成最終的 SQL。
            </div>
            
            <div class="form-group">
                <label for="sqlInput">📝 輸入 SQL：</label>
                <textarea id="sqlInput" class="form-control" placeholder="請輸入包含 'Parm1', 'Parm2' 等參數的 SQL 語句..." rows="8"></textarea>
            </div>
            
            <div class="button-group">
                <button id="extractParamsBtn" class="btn theme-blue">🔍 掃描參數</button>
            </div>
            
            <div class="form-group">
                <label>⚙️ 參數輸入：</label>
                <div id="paramsContainer" class="params-container">
                    <p style="color: rgba(255, 255, 255, 0.7);">請先點擊「掃描參數」來識別 SQL 中的參數</p>
                </div>
            </div>
            
            <div class="button-group">
                <button id="replaceParamsBtn" class="btn theme-blue">🚀 執行替換</button>
            </div>
            
            <div class="form-group">
                <label>✨ 最終 SQL：</label>
                <div id="output" class="output">替換後的 SQL 將在這裡顯示...</div>
            </div>
            
            <div class="button-group">
                <button id="copyBtn" class="btn btn-success">📋 複製</button>
            </div>
        </div>
    </div>

    <script type="module">
        function initializeSqlTool() {
            const extractBtn = document.getElementById('extractParamsBtn');
            const replaceBtn = document.getElementById('replaceParamsBtn');
            const copyBtn = document.getElementById('copyBtn');
            
            if (extractBtn) extractBtn.addEventListener('click', extractParams);
            if (replaceBtn) replaceBtn.addEventListener('click', replaceParams);
            if (copyBtn) copyBtn.addEventListener('click', copySQL);
        }

        function extractParams() {
            const sql = document.getElementById("sqlInput")?.value || "";
            const matches = [...new Set(sql.match(/'Parm\d+'/g))];
            const container = document.getElementById("paramsContainer");
            
            if (!container) return;
            
            if (matches && matches.length > 0) {
                container.innerHTML = matches.map(p => `
                    <div class="param-group">
                        <label>${p}:</label>
                        <input type="text" class="param-input" data-param="${p}" placeholder="請輸入 ${p} 的值">
                    </div>
                `).join("");
            } else {
                container.innerHTML = '<p style="color: rgba(231, 76, 60, 0.9);">未找到任何 \'ParmX\' 參數。請確認 SQL 語句中包含類似 \'Parm1\', \'Parm2\' 的參數。</p>';
            }
        }

        function replaceParams() {
            let sql = document.getElementById("sqlInput")?.value || "";
            
            if (!sql.trim()) {
                alert("請先輸入 SQL 語句");
                return;
            }
            
            const paramInputs = document.querySelectorAll(".param-input");
            if (paramInputs.length === 0) {
                alert("請先掃描參數");
                return;
            }
            
            paramInputs.forEach(input => {
                const param = input.dataset.param;
                const value = input.value.replace(/'/g, "''");
                if (value) {
                    sql = sql.replace(new RegExp(param.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), `'${value}'`);
                }
            });
            
            const output = document.getElementById("output");
            if (output) {
                output.textContent = sql;
            }
        }

        function copySQL() {
            const output = document.getElementById("output");
            if (output) {
                const text = output.textContent;
                if (text && text !== "替換後的 SQL 將在這裡顯示...") {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            const btn = document.getElementById('copyBtn');
                            const originalText = btn.textContent;
                            btn.textContent = '✅ 已複製！';
                            btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';
                            
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.style.background = '';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('複製失敗:', err);
                            alert("複製失敗，請手動複製");
                        });
                } else {
                    alert("沒有可複製的內容");
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeSqlTool();
        });
    </script>
</body>
</html>