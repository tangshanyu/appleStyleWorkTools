<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒæ•¸å­—ä¸²ç‰©ä»¶åŒ–å·¥å…·</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="shared-navigation.js"></script>
    <style>
        .header.theme-green {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.15) 0%, rgba(74, 222, 128, 0.15) 100%);
        }
        
        .btn.theme-green {
            background: linear-gradient(135deg, var(--theme-green) 0%, #22c55e 100%);
        }
        
        .btn.theme-green:hover {
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.25);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header theme-green">
            <h1>åƒæ•¸å­—ä¸²ç‰©ä»¶åŒ–å·¥å…·</h1>
            <p>å°‡ JavaScript åƒæ•¸ä¸²è½‰æ›æˆ amPopUpWindowPost ç‰©ä»¶æ ¼å¼</p>
        </div>
        
        <nav class="nav">
            <!-- å…±ç”¨å°è¦½å°‡ç”± JavaScript è‡ªå‹•è¼‰å…¥ -->
        </nav>
        
        <div class="content">
            <div class="alert alert-info">
                <strong>âœ¨ ä½¿ç”¨èªªæ˜ï¼š</strong>
                è¼¸å…¥åŒ…å«åƒæ•¸ä¸²çš„ JavaScript ä»£ç¢¼ï¼Œå·¥å…·æœƒè‡ªå‹•è§£æä¸¦è½‰æ›ç‚º <code>amPopUpWindowPost</code> æ‰€éœ€çš„ç‰©ä»¶æ ¼å¼ã€‚
                <div class="example">
                    <strong>è¼¸å…¥ç¯„ä¾‹ï¼š</strong><br>
                    var params = "criteria.wrtoffTxSn=" + $("#finSlnClsPosTxSn").val() +<br>
                    "&criteria.contrNo=" + $("#contrNo").val() + <br>
                    "&criteria.sn=1";<br><br>
                    <strong>è¼¸å‡ºç¯„ä¾‹ï¼š</strong><br>
                    var url = "/dal/dal11032/process";<br>
                    var paramObj = {<br>
                    &nbsp;&nbsp;"progId": "AMDAL11032",<br>
                    &nbsp;&nbsp;"criteria.wrtoffTxSn": $("#finSlnClsPosTxSn").val(),<br>
                    &nbsp;&nbsp;...<br>
                    };<br>
                    amPopUpWindowPost({winSize: "L", url: url, params: paramObj});
                </div>
            </div>
            
            <div class="form-group">
                <label for="rawInput">ğŸ“ åŸå§‹åƒæ•¸ä»£ç¢¼ï¼š</label>
                <textarea id="rawInput" class="form-control" rows="12" 
                    placeholder='è²¼ä¸Šå®Œæ•´çš„åƒæ•¸ä»£ç¢¼ï¼Œä¾‹å¦‚ï¼š
var params = "criteria.wrtoffTxSn=" + $("#finSlnClsPosTxSn").val() +
"&criteria.contrNo=" + $("#contrNo").val() + 
"&criteria.sn=1";'></textarea>
            </div>
            
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="includeAfterCall">
                    <label for="includeAfterCall">ğŸ”§ åŒ…å« aftercall å›èª¿å‡½æ•¸</label>
                </div>
            </div>
            
            <div class="form-group" id="afterCallGroup" style="display: none;">
                <label for="afterCallInput">ğŸ“ aftercall å‡½æ•¸åç¨±ï¼š</label>
                <input id="afterCallInput" class="form-control" 
                    placeholder="ä¾‹å¦‚ï¼šmyCallbackFunction" />
            </div>
            
            <div class="button-group">
                <button id="convertBtn" class="btn theme-green">ğŸš€ è½‰æ›</button>
                <button id="copyBtn" class="btn btn-success">ğŸ“‹ è¤‡è£½çµæœ</button>
                <button id="clearBtn" class="btn">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
            
            <div class="form-group">
                <label>âœ¨ è½‰æ›å¾Œä»£ç¢¼ï¼š</label>
                <div id="resultOutput" class="output">çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...</div>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ› aftercall è¼¸å…¥æ¡†é¡¯ç¤º
        document.getElementById('includeAfterCall').addEventListener('change', function() {
            const afterCallGroup = document.getElementById('afterCallGroup');
            afterCallGroup.style.display = this.checked ? 'block' : 'none';
        });

        function parseParamsString(input) {
            try {
                // æ¸…ç†è¼¸å…¥ï¼Œç§»é™¤ var params = éƒ¨åˆ†
                let cleaned = input.replace(/var\s+params\s*=\s*/i, '').trim();
                
                // ç§»é™¤é–‹é ­å’Œçµå°¾çš„å¼•è™Ÿå’Œåˆ†è™Ÿ
                cleaned = cleaned.replace(/^["']|["'];?$/g, '');
                
                // æå– URL éƒ¨åˆ†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let url = "/dal/dal11032/process"; // é»˜èªURL
                const urlMatch = cleaned.match(/url:\s*["']([^"']+)["']/);
                if (urlMatch) {
                    url = urlMatch[1];
                }
                
                // è§£æåƒæ•¸
                const paramObj = {};
                
                // åˆ†å‰²åƒæ•¸å­—ä¸²ï¼Œè™•ç†é€£æ¥ç¬¦è™Ÿ +
                const parts = cleaned.split(/"\s*\+\s*"|\+\s*"/g);
                
                parts.forEach(part => {
                    part = part.trim().replace(/^["']|["']$/g, '');
                    
                    // å°‹æ‰¾ key=value æ¨¡å¼
                    if (part.includes('=')) {
                        const paramMatches = part.match(/([^&=]+)=([^&]*)/g);
                        
                        if (paramMatches) {
                            paramMatches.forEach(match => {
                                const [key, ...valueParts] = match.split('=');
                                const value = valueParts.join('=');
                                
                                if (key && key.trim()) {
                                    const cleanKey = key.replace(/^&/, '').trim();
                                    
                                    // è™•ç†ä¸åŒé¡å‹çš„å€¼
                                    let cleanValue = value.trim();
                                    
                                    // æª¢æŸ¥æ˜¯å¦æ˜¯ jQuery é¸æ“‡å™¨
                                    const jqueryMatch = input.match(new RegExp(`["']${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']\\s*\\+\\s*([^"'\\+]+)`, 'i'));
                                    if (jqueryMatch) {
                                        cleanValue = jqueryMatch[1].trim();
                                    }
                                    
                                    paramObj[cleanKey] = cleanValue;
                                }
                            });
                        }
                    }
                });
                
                return { url, paramObj };
            } catch (error) {
                console.error('è§£æéŒ¯èª¤:', error);
                throw new Error('ç„¡æ³•è§£æåƒæ•¸æ ¼å¼ï¼Œè«‹æª¢æŸ¥è¼¸å…¥');
            }
        }

        function formatOutput(url, paramObj, includeAfterCall, afterCallFunction) {
            // æ·»åŠ å›ºå®šåƒæ•¸
            const finalParamObj = {
                progId: "AMDAL11032",
                progAction: "process",
                ...paramObj
            };
            
            const lines = [
                `var url = "${url}";`,
                "var paramObj = {"
            ];
            
            // æ ¼å¼åŒ–åƒæ•¸ç‰©ä»¶
            const entries = Object.entries(finalParamObj);
            entries.forEach(([key, value], index) => {
                const isLast = index === entries.length - 1;
                const comma = isLast ? '' : ',';
                
                // è™•ç†å€¼çš„æ ¼å¼
                let formattedValue;
                if (typeof value === 'string' && (value.includes('$("#') || value.includes("$('") || value.includes('.val()'))) {
                    // jQuery é¸æ“‡å™¨ï¼Œä¿æŒåŸæ¨£
                    formattedValue = value;
                } else if (typeof value === 'string' && value.includes('<s:property')) {
                    // Struts æ¨™ç±¤ï¼Œä¿æŒåŸæ¨£ä¸¦åŠ å¼•è™Ÿ
                    formattedValue = `"${value}"`;
                } else if (typeof value === 'string' && value.includes('.toNumber()')) {
                    // å¸¶æœ‰ .toNumber() çš„è¡¨é”å¼
                    formattedValue = value;
                } else if (!isNaN(value) && value !== '' && typeof value !== 'string') {
                    // ç´”æ•¸å­—
                    formattedValue = value;
                } else {
                    // å­—ä¸²ï¼Œéœ€è¦åŠ å¼•è™Ÿï¼Œä½†è¦è™•ç†å·²ç¶“æ˜¯è¡¨é”å¼çš„æƒ…æ³
                    if (typeof value === 'string' && (value.startsWith('"') || value.includes('('))) {
                        formattedValue = value;
                    } else {
                        formattedValue = `"${value}"`;
                    }
                }
                
                lines.push(`    "${key}": ${formattedValue}${comma}`);
            });
            
            lines.push("};");
            
            // æ§‹å»º amPopUpWindowPost èª¿ç”¨
            const popupParams = [`winSize: "L"`, `url: url`, `params: paramObj`];
            
            if (includeAfterCall && afterCallFunction) {
                popupParams.push(`aftercall: ${afterCallFunction}`);
            }
            
            lines.push(`amPopUpWindowPost({${popupParams.join(', ')}});`);
            
            return lines.join('\n');
        }

        document.getElementById('convertBtn').addEventListener('click', () => {
            const rawInput = document.getElementById('rawInput').value.trim();
            
            if (!rawInput) {
                alert('è«‹å…ˆè¼¸å…¥åŸå§‹åƒæ•¸ä»£ç¢¼');
                return;
            }
            
            try {
                const { url, paramObj } = parseParamsString(rawInput);
                const includeAfterCall = document.getElementById('includeAfterCall').checked;
                const afterCallFunction = document.getElementById('afterCallInput').value.trim();
                
                const result = formatOutput(url, paramObj, includeAfterCall, afterCallFunction);
                document.getElementById('resultOutput').textContent = result;
            } catch (error) {
                alert('è§£æå¤±æ•—ï¼š' + error.message);
                console.error('è©³ç´°éŒ¯èª¤:', error);
            }
        });

        document.getElementById('copyBtn').addEventListener('click', () => {
            const text = document.getElementById('resultOutput').textContent;
            if (!text.trim() || text.includes('çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡')) {
                alert('è«‹å…ˆè½‰æ›å¾Œå†è¤‡è£½');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('rawInput').value = '';
            document.getElementById('afterCallInput').value = '';
            document.getElementById('includeAfterCall').checked = false;
            document.getElementById('afterCallGroup').style.display = 'none';
            document.getElementById('resultOutput').textContent = 'çµæœå°‡é¡¯ç¤ºåœ¨é€™è£¡...';
        });
    </script>
</body>
</html>