<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL è½‰ Java sb.append() å·¥å…·</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="shared-navigation.js"></script>
    <!-- å¼•å…¥ Poor SQL æœ¬åœ°æ ¼å¼åŒ–åº« -->
    <script src="poorsql.js"></script>
    <style>
        .header.theme-orange {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.12) 0%, rgba(251, 146, 60, 0.1) 100%);
        }
        
        .btn.theme-orange {
            background: linear-gradient(135deg, var(--theme-orange) 0%, #f97316 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            font-size: 16px;
        }
        
        .btn.theme-orange:hover {
            box-shadow: 0 8px 25px rgba(249, 115, 22, 0.3);
            transform: translateY(-1px);
        }

        .format-method-section {
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .format-method-title {
            font-size: 20px;
            font-weight: 700;
            color: #0c4a6e;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            background: white;
            transition: all 0.3s;
            font-weight: 500;
        }

        .format-option:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }

        .format-option.active {
            border-color: #0ea5e9;
            background: #dbeafe;
        }

        .format-option input[type="radio"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }

        .iframe-container {
            display: none;
            margin-top: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .iframe-header {
            background: #f8fafc;
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .iframe-header h4 {
            margin: 0;
            color: #1f2937;
            font-size: 16px;
        }

        .iframe-refresh-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .iframe-refresh-btn:hover {
            background: #059669;
        }

        .poor-sql-iframe {
            width: 100%;
            height: 500px;
            border: none;
        }

        .local-section {
            display: block;
            margin-top: 20px;
            padding: 16px;
            background: #f0fdf4;
            border-radius: 8px;
            border: 1px solid #22c55e;
        }

        .local-info {
            color: #15803d;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .workflow-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 20px;
        }

        .workflow-step {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            background: white;
            position: relative;
            transition: all 0.3s ease;
        }

        .workflow-step:hover {
            border-color: #f97316;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.1);
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-number {
            background: #f97316;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }

        .step-textarea {
            width: 100%;
            min-height: 200px;
            font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            resize: vertical;
            line-height: 1.5;
            tab-size: 4;
            white-space: pre;
            color: #1f2937;
            background-color: white;
        }

        .step-textarea:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
            outline: none;
        }

        .step-output {
            width: 100%;
            min-height: 200px;
            font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 12px;
            background-color: #f8fafc;
            line-height: 1.5;
            tab-size: 4;
            white-space: pre;
            overflow-x: auto;
            color: #1f2937;
        }

        .copy-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: #22c55e;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: #f97316;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: #ea580c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .action-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .options-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .options-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 12px;
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .option-item label {
            color: #1f2937;
            font-weight: 500;
        }

        .placeholder-text {
            color: #6b7280;
            font-style: italic;
            padding: 20px;
            text-align: center;
            background-color: transparent;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: #22c55e; }
        .status-pending { background: #f59e0b; }
        .status-empty { background: #9ca3af; }

        .workflow-step * {
            color: #1f2937;
        }

        .workflow-step .placeholder-text {
            color: #6b7280;
        }

        .workflow-step .copy-btn {
            color: white;
        }

        .workflow-step .action-btn {
            color: white;
        }

        .workflow-step .step-number {
            color: white;
        }

        .quick-actions {
            margin-top: 30px; 
            text-align: center; 
            padding: 20px; 
            background: #f8fafc; 
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .quick-actions h3 {
            margin-bottom: 15px;
            color: #1f2937;
            font-size: 20px;
        }

        .quick-actions .action-btn {
            font-size: 16px; 
            padding: 15px 30px;
        }

        .quick-actions .clear-all-btn {
            background: #ef4444; 
            margin-left: 15px;
        }

        .quick-actions .clear-all-btn:hover {
            background: #dc2626;
        }

        .format-instruction {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
            font-size: 14px;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header theme-orange">
            <h1>SQL è½‰ Java sb.append()</h1>
            <p>æ•´åˆæœ¬åœ° Poor SQL æ ¼å¼åŒ– + å››æ­¥é©Ÿè½‰æ›æµç¨‹</p>
        </div>
        
        <nav class="nav">
            <!-- å…±ç”¨å°è¦½å°‡ç”± JavaScript è‡ªå‹•è¼‰å…¥ -->
        </nav>
        
        <div class="content">
            <!-- Poor SQL æ ¼å¼åŒ–æ–¹å¼é¸æ“‡ -->
            <div class="format-method-section">
                <div class="format-method-title">
                    ğŸ¯ SQL æ ¼å¼åŒ–æ–¹å¼é¸æ“‡
                </div>
                
                <div class="format-options">
                    <label class="format-option active" id="option-local">
                        <input type="radio" name="formatMethod" value="local" checked>
                        <div>
                            <strong>ğŸ—‚ï¸ æœ¬åœ° Poor SQL</strong>
                            <div style="font-size: 12px; color: #6b7280;">ä½¿ç”¨æœ¬åœ° poorsql.jsï¼ˆæ¨è–¦ï¼‰</div>
                        </div>
                    </label>
                    
                    <label class="format-option" id="option-iframe">
                        <input type="radio" name="formatMethod" value="iframe">
                        <div>
                            <strong>ğŸŒ Poor SQL ç¶²é </strong>
                            <div style="font-size: 12px; color: #6b7280;">åµŒå…¥å¼ç¶²é æ ¼å¼åŒ–</div>
                        </div>
                    </label>
                    
                    <label class="format-option" id="option-manual">
                        <input type="radio" name="formatMethod" value="manual">
                        <div>
                            <strong>âœ‹ æ‰‹å‹•è¼¸å…¥</strong>
                            <div style="font-size: 12px; color: #6b7280;">è‡ªè¡Œè™•ç†æ ¼å¼åŒ–</div>
                        </div>
                    </label>
                </div>

                <!-- æœ¬åœ° Poor SQL èªªæ˜å€ -->
                <div class="local-section" id="local-section">
                    <div class="local-info">
                        ğŸ—‚ï¸ ä½¿ç”¨æœ¬åœ° poorsql.js é€²è¡Œæ ¼å¼åŒ–ï¼Œå®Œå…¨é›¢ç·šé‹ä½œï¼Œé€Ÿåº¦å¿«ä¸”ç©©å®šã€‚
                    </div>
                </div>

                <!-- iframe å€åŸŸ -->
                <div class="iframe-container" id="iframe-container">
                    <div class="iframe-header">
                        <h4>ğŸŒ Poor SQL ç·šä¸Šæ ¼å¼åŒ–å·¥å…·</h4>
                        <button class="iframe-refresh-btn" onclick="refreshPoorSqlIframe()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    </div>
                    <iframe id="poor-sql-iframe" class="poor-sql-iframe" src="https://poorsql.com/"></iframe>
                    <div class="format-instruction">
                        ğŸ’¡ <strong>ä½¿ç”¨èªªæ˜ï¼š</strong> åœ¨ä¸Šæ–¹ Poor SQL ç¶²é ä¸­è²¼ä¸Šæ‚¨çš„ SQLï¼Œæ ¼å¼åŒ–å®Œæˆå¾Œè¤‡è£½çµæœï¼Œç„¶å¾Œé»æ“Šä¸‹æ–¹ã€Œå¾ Poor SQL å–å¾—çµæœã€æŒ‰éˆ•ã€‚
                    </div>
                </div>
            </div>
            <div class="workflow-container">
                <!-- æ­¥é©Ÿ 1: åŸå§‹ SQL è¼¸å…¥ -->
                <div class="workflow-step">
                    <div class="step-header">
                        <div class="step-title">
                            <div class="step-number">1</div>
                            åŸå§‹ SQL è¼¸å…¥
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('sqlInput')">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <textarea 
                        id="sqlInput" 
                        class="step-textarea" 
                        placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„åŸå§‹ SQL èªå¥..."></textarea>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="clearStep(1)">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="action-btn" onclick="loadTestSql()">ğŸ§ª è¼‰å…¥æ¸¬è©¦è³‡æ–™</button>
                    </div>
                </div>
                 <!-- æ ¼å¼åŒ–æŒ‰éˆ• -->
                <div class="action-buttons">
                    <button class="action-btn" onclick="executePoorSqlFormat()">
                        ğŸ¨ åŸ·è¡Œ Poor SQL æ ¼å¼åŒ–
                    </button>
                    <button class="action-btn" id="get-from-poorsql-btn" onclick="getFromPoorSql()" style="display: none; background: #10b981;">
                        ğŸ“¥ å¾ Poor SQL å–å¾—çµæœ
                    </button>
                </div>
                <!-- æ­¥é©Ÿ 2: æ ¼å¼åŒ–å¾Œ SQL -->
                <div class="workflow-step">
                    <div class="step-header">
                        <div class="step-title">
                            <div class="step-number">2</div>
                            æ ¼å¼åŒ–å¾Œ SQL (Poor SQL)
                            <span class="status-indicator status-empty" id="status2"></span>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('formattedSql')">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <div id="formattedSql" class="step-output">
                        <div class="placeholder-text">è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡æ ¼å¼åŒ–æ–¹å¼ä¸¦åŸ·è¡Œ Poor SQL æ ¼å¼åŒ–</div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="clearStep(2)">ğŸ—‘ï¸ æ¸…ç©º</button>
                        <button class="action-btn" onclick="editFormattedSql()">âœï¸ æ‰‹å‹•ç·¨è¼¯</button>
                    </div>
                </div>
            <!-- è™•ç†é¸é … -->
            <div class="options-section">
                <div class="options-title">âš™ï¸ å¾ŒçºŒè™•ç†é¸é …</div>
                <div class="option-group">
                    <div class="option-item">
                        <input type="checkbox" id="camelCaseAsCheckbox">
                        <label for="camelCaseAsCheckbox">ğŸª SELECT æ¬„ä½ä½¿ç”¨é§å³°å‘½å AS åˆ¥å</label>
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="hibernateCheckbox">
                        <label for="hibernateCheckbox">ğŸ—ï¸ ç”¢ç”Ÿ HibernateScalarHelper</label>
                    </div>
                </div>
            </div>
                <!-- æ­¥é©Ÿ 3: sb.append() çµæœ -->
                <div class="workflow-step">
                    <div class="step-header">
                        <div class="step-title">
                            <div class="step-number">3</div>
                            sb.append() çµæœ
                            <span class="status-indicator status-empty" id="status3"></span>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('sbAppendOutput')">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <div id="sbAppendOutput" class="step-output">
                        <div class="placeholder-text">å…ˆå®Œæˆæ­¥é©Ÿ 2ï¼Œç„¶å¾Œé»æ“Šã€Œè½‰æ›ç‚º sb.append()ã€</div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="convertToSbAppend()">âš¡ è½‰æ›ç‚º sb.append()</button>
                        <button class="action-btn" onclick="clearStep(3)">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ 4: HibernateScalarHelper -->
                <div class="workflow-step">
                    <div class="step-header">
                        <div class="step-title">
                            <div class="step-number">4</div>
                            HibernateScalarHelper
                            <span class="status-indicator status-empty" id="status4"></span>
                        </div>
                        <button class="copy-btn" onclick="copyToClipboard('hibernateOutput')">ğŸ“‹ è¤‡è£½</button>
                    </div>
                    <div id="hibernateOutput" class="step-output">
                        <div class="placeholder-text">å‹¾é¸ã€Œç”¢ç”Ÿ HibernateScalarHelperã€é¸é …ï¼Œç„¶å¾ŒåŸ·è¡Œæ­¥é©Ÿ 3</div>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="generateHibernateHelper()">ğŸ—ï¸ ç”Ÿæˆ HibernateScalarHelper</button>
                        <button class="action-btn" onclick="clearStep(4)">ğŸ—‘ï¸ æ¸…ç©º</button>
                    </div>
                </div>
            </div>

            <!-- å¿«æ·æ“ä½œå€ -->
            <div class="quick-actions">
                <h3>ğŸš€ ä¸€éµåŸ·è¡Œ</h3>
                <button class="action-btn" onclick="executeAllSteps()">
                    âš¡ åŸ·è¡Œæ‰€æœ‰æ­¥é©Ÿ
                </button>
                <button class="action-btn clear-all-btn" onclick="clearAllSteps()">
                    ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰
                </button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¬è©¦ç”¨ SQL
        const TEST_SQL = `SELECT CB_DTA.CONTR_NO, CB_DTA.SELL_DEAL_ACC_DATE, CB_DTA.SELL_VLU_ACC_DATE, CB_DTA.SELL_SETT_ACC_DATE, CB_DTA.STCURR, CB_DTA.FIN_ASET_CTG_OPT_CTG, CB_DTA.FIN_ASET_CTG, CB_DTA.ACC_CTG, e.ACC_BASE, e.EVCURR, e.BIZ_CTG_1, f.TAX_FREE_MARK, e.BSCURR_FEXG_TYP, e.FEXG_TYP, e.NO_DIRRATE_YN_USE_CROSSRATE, t.CURR_DCML_LSD, SUM(CB_DTA.SELL_COST) AS TOT_SELL_COST, SUM(CB_DTA.SELL_DEAL_AMT) AS TOT_SELL_DEAL_AMT, SUM(CB_DTA.SELL_SETT_AMT) AS TOT_SELL_SETT_AMT FROM ( SELECT '1202-3000' AS ACC_PRD_COMB, ad.CONTR_NO, ad.ACC_CTG, ad.SELL_DEAL_DATE, ad.SELL_DEAL_ACC_DATE, ad.SELL_SETT_DATE, ad.SELL_SETT_ACC_DATE, ad.SELL_VLU_DATE, ad.SELL_VLU_ACC_DATE, ad.STCURR, ad.FIN_ASET_CTG_OPT_CTG, ad.FIN_ASET_CTG FROM AM_TX_SELL_CB ad WHERE ad.CONTR_NO IN ('Parm1') AND ad.FIN_ASET_CTG = '01' ) CB_DTA JOIN AM_C_MST e ON CB_DTA.CONTR_NO = e.CONTR_NO JOIN AM_C_SUB_CB f ON e.CONTR_NO = f.CONTR_NO JOIN COMM_CURR t ON t.CURR_CDE = e.EVCURR GROUP BY CB_DTA.CONTR_NO, CB_DTA.FIN_ASET_CTG_OPT_CTG ORDER BY CB_DTA.CONTR_NO, CB_DTA.FIN_ASET_CTG_OPT_CTG`;

        // æ ¼å¼åŒ–æ–¹å¼åˆ‡æ›
        function handleFormatMethodChange() {
            const selectedMethod = document.querySelector('input[name="formatMethod"]:checked').value;
            const iframeContainer = document.getElementById('iframe-container');
            const localSection = document.getElementById('local-section');
            const getFromPoorSqlBtn = document.getElementById('get-from-poorsql-btn');
            
            // æ›´æ–°é¸é …æ¨£å¼
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById(`option-${selectedMethod}`).classList.add('active');
            
            // é¡¯ç¤º/éš±è—ç›¸é—œå€åŸŸ
            if (selectedMethod === 'iframe') {
                iframeContainer.style.display = 'block';
                localSection.style.display = 'none';
                getFromPoorSqlBtn.style.display = 'inline-flex';
            } else if (selectedMethod === 'local') {
                iframeContainer.style.display = 'none';
                localSection.style.display = 'block';
                getFromPoorSqlBtn.style.display = 'none';
            } else {
                iframeContainer.style.display = 'none';
                localSection.style.display = 'none';
                getFromPoorSqlBtn.style.display = 'none';
            }
        }

        // åˆ·æ–° Poor SQL iframe
        function refreshPoorSqlIframe() {
            document.getElementById('poor-sql-iframe').src = 'https://poorsql.com/';
        }

        // åŸ·è¡Œ Poor SQL æ ¼å¼åŒ–
        async function executePoorSqlFormat() {
            const sql = document.getElementById('sqlInput').value.trim();
            const selectedMethod = document.querySelector('input[name="formatMethod"]:checked').value;
            
            if (!sql) {
                alert('è«‹å…ˆè¼¸å…¥ SQL èªå¥');
                return;
            }

            if (selectedMethod === 'iframe') {
                alert('è«‹åœ¨ä¸Šæ–¹çš„ Poor SQL ç¶²é ä¸­æ ¼å¼åŒ–æ‚¨çš„ SQLï¼Œå®Œæˆå¾Œé»æ“Šã€Œå¾ Poor SQL å–å¾—çµæœã€æŒ‰éˆ•');
                return;
            }

            if (selectedMethod === 'manual') {
                // æ‰‹å‹•æ¨¡å¼ï¼šç›´æ¥å°‡åŸå§‹ SQL è¤‡è£½åˆ°æ ¼å¼åŒ–å€åŸŸ
                document.getElementById('formattedSql').textContent = sql;
                updateStatus(2, 'ready');
                alert('æ‰‹å‹•æ¨¡å¼ï¼šåŸå§‹ SQL å·²è¤‡è£½åˆ°æ ¼å¼åŒ–å€åŸŸï¼Œæ‚¨å¯ä»¥æ‰‹å‹•ç·¨è¼¯');
                return;
            }

            // æœ¬åœ° Poor SQL æ¨¡å¼
            updateStatus(2, 'pending');

            try {
                let formattedSql = await formatWithLocalPoorSql(sql);
                document.getElementById('formattedSql').textContent = formattedSql;
                updateStatus(2, 'ready');
                alert('SQL æ ¼å¼åŒ–å®Œæˆï¼');
            } catch (error) {
                console.error('æ ¼å¼åŒ–å¤±æ•—:', error);
                // ä½¿ç”¨å‚™ç”¨æ ¼å¼åŒ–
                let fallbackSql = basicFormat(sql);
                document.getElementById('formattedSql').textContent = fallbackSql;
                updateStatus(2, 'ready');
                alert('Poor SQL æ ¼å¼åŒ–å‡ºç¾å•é¡Œï¼Œå·²ä½¿ç”¨åŸºæœ¬æ ¼å¼åŒ–');
            }
        }

        // æœ¬åœ° Poor SQL æ ¼å¼åŒ–
        function formatWithLocalPoorSql(sql) {
            try {
                // æª¢æŸ¥ Poor SQL æ˜¯å¦è¼‰å…¥æˆåŠŸ
                if (typeof PoorMansTSqlFormatterLib === 'undefined') {
                    throw new Error('Poor SQL åº«æœªæ­£ç¢ºè¼‰å…¥');
                }

                // ä½¿ç”¨ Poor SQL æ ¼å¼åŒ–
                const formatter = new PoorMansTSqlFormatterLib.Formatters.TSqlStandardFormatter();
                
                // è¨­å®šæ ¼å¼åŒ–é¸é …
                formatter.IndentString = '\t';       // ä½¿ç”¨ tab ç¸®æ’
                formatter.SpacesPerTab = 4;         // tab ç­‰æ–¼ 4 å€‹ç©ºæ ¼
                formatter.MaxLineWidth = 999;       // æœ€å¤§è¡Œå¯¬
                formatter.NewStatementLineBreaks = 2; // èªå¥é–“æ›è¡Œ
                formatter.NewClauseLineBreaks = 1;   // å­å¥é–“æ›è¡Œ
                
                // å»ºç«‹è§£æå™¨å’Œæ ¼å¼åŒ–å™¨
                const parser = new PoorMansTSqlFormatterLib.Parsers.TSqlStandardParser();
                const tokenizer = new PoorMansTSqlFormatterLib.Tokenizers.TSqlStandardTokenizer();
                
                // æ ¼å¼åŒ– SQL
                const tokens = tokenizer.TokenizeSQL(sql);
                const parsedTree = parser.ParseSQL(tokens);
                const formattedSql = formatter.FormatSQLTree(parsedTree);
                
                return formattedSql;
                
            } catch (error) {
                console.error('æœ¬åœ° Poor SQL æ ¼å¼åŒ–å¤±æ•—:', error);
                // å›é€€åˆ°åŸºæœ¬æ ¼å¼åŒ–
                return basicFormat(sql);
            }
        }

        // å¾ Poor SQL å–å¾—çµæœ
        function getFromPoorSql() {
            const userInput = prompt('è«‹è²¼ä¸Šå¾ Poor SQL æ ¼å¼åŒ–å¾Œçš„ SQL çµæœï¼š');
            if (userInput && userInput.trim()) {
                document.getElementById('formattedSql').textContent = userInput.trim();
                updateStatus(2, 'ready');
                alert('å·²æˆåŠŸå–å¾— Poor SQL æ ¼å¼åŒ–çµæœï¼');
            }
        }

        // æ‰‹å‹•ç·¨è¼¯æ ¼å¼åŒ–çµæœ
        function editFormattedSql() {
            const currentContent = document.getElementById('formattedSql').textContent;
            const newContent = prompt('ç·¨è¼¯æ ¼å¼åŒ–å¾Œçš„ SQLï¼š', currentContent);
            if (newContent !== null) {
                document.getElementById('formattedSql').textContent = newContent;
                if (newContent.trim()) {
                    updateStatus(2, 'ready');
                } else {
                    updateStatus(2, 'empty');
                }
            }
        }

        // è¼‰å…¥æ¸¬è©¦ SQL
        function loadTestSql() {
            document.getElementById('sqlInput').value = TEST_SQL;
            updateStatus(1, 'ready');
        }

        // åŸºæœ¬æ ¼å¼åŒ–å‡½æ•¸ï¼ˆä½œç‚ºå‚™ç”¨ï¼‰
        function basicFormat(sql) {
            return sql
                .replace(/\bselect\b/gi, 'SELECT')
                .replace(/\bfrom\b/gi, 'FROM')
                .replace(/\bwhere\b/gi, 'WHERE')
                .replace(/\bjoin\b/gi, 'JOIN')
                .replace(/\bleft join\b/gi, 'LEFT JOIN')
                .replace(/\bright join\b/gi, 'RIGHT JOIN')
                .replace(/\binner join\b/gi, 'INNER JOIN')
                .replace(/\bgroup by\b/gi, 'GROUP BY')
                .replace(/\border by\b/gi, 'ORDER BY')
                .replace(/\band\b/gi, 'AND')
                .replace(/\bor\b/gi, 'OR')
                .replace(/\bas\b/gi, 'AS')
                .replace(/\bon\b/gi, 'ON')
                .replace(/\bin\b/gi, 'IN');
        }

        // è½‰æ›ç‚º sb.append()
        function convertToSbAppend() {
            const formattedSql = document.getElementById('formattedSql').textContent.trim();
            
            if (!formattedSql || formattedSql.includes('è«‹å…ˆåœ¨ä¸Šæ–¹')) {
                alert('è«‹å…ˆå®Œæˆ SQL æ ¼å¼åŒ–ï¼ˆæ­¥é©Ÿ 2ï¼‰');
                return;
            }

            updateStatus(3, 'pending');

            let sql = formattedSql;
            const useCamelCaseAs = document.getElementById('camelCaseAsCheckbox').checked;

            // å¦‚æœå•Ÿç”¨é§å³°å‘½åï¼Œè™•ç† AS åˆ¥å
            if (useCamelCaseAs) {
                sql = addCamelCaseAS(sql);
            }

            // è½‰æ›ç‚º sb.append() æ ¼å¼
            const lines = sql.split('\n');
            const sbAppendResult = [];

            lines.forEach(line => {
                if (!line.trim()) return;

                const commentInfo = extractComments(line);
                const code = commentInfo.code.trim();

                if (code) {
                    const escapedCode = code.replace(/"/g, '\\"');
                    const originalIndent = line.match(/^(\s*)/)[1];
                    let appendStatement = `sb.append(" ${originalIndent}${escapedCode} ");`;

                    if (commentInfo.hasComment && commentInfo.comment) {
                        appendStatement += ` // ${commentInfo.comment}`;
                    }

                    sbAppendResult.push(appendStatement);
                }
            });

            document.getElementById('sbAppendOutput').textContent = sbAppendResult.join('\n');
            updateStatus(3, 'ready');

            // å¦‚æœå‹¾é¸äº† HibernateScalarHelperï¼Œè‡ªå‹•ç”Ÿæˆ
            if (document.getElementById('hibernateCheckbox').checked) {
                generateHibernateHelperFromSql(sql);
            }
        }

        // ç”Ÿæˆ HibernateScalarHelper
        function generateHibernateHelper() {
            const formattedSql = document.getElementById('formattedSql').textContent.trim();
            
            if (!formattedSql || formattedSql.includes('è«‹å…ˆåœ¨ä¸Šæ–¹')) {
                alert('è«‹å…ˆå®Œæˆ SQL æ ¼å¼åŒ–ï¼ˆæ­¥é©Ÿ 2ï¼‰');
                return;
            }

            generateHibernateHelperFromSql(formattedSql);
        }

        function generateHibernateHelperFromSql(sql) {
            updateStatus(4, 'pending');

            try {
                const selectFields = parseSelectFields(sql);

                if (selectFields.length === 0) {
                    document.getElementById('hibernateOutput').innerHTML = '<div class="placeholder-text">ç„¡æ³•è­˜åˆ¥ SELECT èªå¥ï¼Œè«‹æª¢æŸ¥ SQL æ ¼å¼</div>';
                    updateStatus(4, 'empty');
                    return;
                }

                const fields = selectFields.map(field => {
                    const cleanField = field.replace(/--.*$/, '').trim();

                    const asMatch = cleanField.match(/\s+AS\s+(\w+)/i);
                    if (asMatch) {
                        return asMatch[1];
                    }

                    let fieldName = cleanField;

                    if (fieldName.includes('.')) {
                        fieldName = fieldName.split('.').pop();
                    }

                    fieldName = fieldName.replace(/[^\w]/g, '');

                    return fieldName;
                }).filter(field => field && field.trim() !== '');

                if (fields.length > 0) {
                    const hibernateList = fields.map(field =>
                        `scalarList.add(new HibernateScalarHelper("${field}", StandardBasicTypes.STRING));`
                    ).join('\n');

                    const hibernateResult = `List<HibernateScalarHelper> scalarList = new ArrayList<>();\n${hibernateList}`;
                    document.getElementById('hibernateOutput').textContent = hibernateResult;
                    updateStatus(4, 'ready');
                } else {
                    document.getElementById('hibernateOutput').innerHTML = '<div class="placeholder-text">ç„¡æ³•æå–åˆ°æœ‰æ•ˆçš„æ¬„ä½å</div>';
                    updateStatus(4, 'empty');
                }
            } catch (error) {
                console.error('ç”Ÿæˆ HibernateScalarHelper æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                document.getElementById('hibernateOutput').innerHTML = '<div class="placeholder-text">ç”Ÿæˆ HibernateScalarHelper æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message + '</div>';
                updateStatus(4, 'empty');
            }
        }

        // è§£æ SELECT æ¬„ä½
        function parseSelectFields(sql) {
            try {
                let cleanSql = sql.replace(/--.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, '');

                const selectMatch = cleanSql.match(/\bSELECT\s+([\s\S]+?)(?:\s+FROM\b|\s+INTO\b|\s*$)/i);

                if (!selectMatch) {
                    return [];
                }

                const fieldsText = selectMatch[1].trim();
                const fields = fieldsText.split(',').map(f => f.trim()).filter(f => f);

                return fields;
            } catch (error) {
                console.error('è§£æ SELECT æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return [];
            }
        }

        // é§å³°å‘½åè™•ç†
        function addCamelCaseAS(sql) {
            const lines = sql.split('\n');
            let inSelectClause = false;

            const processedLines = lines.map(line => {
                const trimmed = line.trim().toUpperCase();

                if (trimmed.startsWith('SELECT')) {
                    inSelectClause = true;
                } else if (inSelectClause && (trimmed.startsWith('FROM') || trimmed.startsWith('WHERE') || trimmed.startsWith('GROUP BY'))) {
                    inSelectClause = false;
                }

                if (inSelectClause && !trimmed.startsWith('SELECT') && trimmed !== '') {
                    return processSelectLine(line);
                }

                return line;
            });

            return processedLines.join('\n');
        }

        function processSelectLine(line) {
            const indent = line.match(/^(\s*)/)[1];
            let content = line.trim();

            if (!content.toUpperCase().includes(' AS ') && content.includes('.')) {
                const parts = content.split('.');
                const fieldName = parts[parts.length - 1].replace(/[^\w]/g, '');

                if (!isNamField(fieldName) && fieldName.includes('_')) {
                    const camelCaseName = toCamelCase(fieldName);
                    content += ` AS ${camelCaseName}`;
                }
            }

            return indent + content;
        }

        function toCamelCase(str) {
            return str.split('_').map((word, index) => {
                if (index === 0) {
                    return word.toLowerCase();
                }
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join('');
        }

        function isNamField(fieldName) {
            const lowerFieldName = fieldName.toLowerCase();
            return lowerFieldName.includes('nam') ||
                lowerFieldName.includes('name') ||
                lowerFieldName.startsWith('nam_') ||
                lowerFieldName.endsWith('_nam') ||
                lowerFieldName.startsWith('name_') ||
                lowerFieldName.endsWith('_name');
        }

        // æå–è¨»é‡‹
        function extractComments(line) {
            const result = {
                code: line,
                comment: '',
                hasComment: false
            };

            const singleLineCommentMatch = line.match(/^(.*?)--(.*)$/);
            if (singleLineCommentMatch) {
                result.code = singleLineCommentMatch[1].trimEnd();
                result.comment = singleLineCommentMatch[2].trim();
                result.hasComment = true;
            }

            return result;
        }

        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatus(step, status) {
            const indicator = document.getElementById(`status${step}`);
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
        }

        // æ¸…ç©ºæŒ‡å®šæ­¥é©Ÿ
        function clearStep(step) {
            switch (step) {
                case 1:
                    document.getElementById('sqlInput').value = '';
                    updateStatus(1, 'empty');
                    break;
                case 2:
                    document.getElementById('formattedSql').innerHTML = '<div class="placeholder-text">è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡æ ¼å¼åŒ–æ–¹å¼ä¸¦åŸ·è¡Œ Poor SQL æ ¼å¼åŒ–</div>';
                    updateStatus(2, 'empty');
                    break;
                case 3:
                    document.getElementById('sbAppendOutput').innerHTML = '<div class="placeholder-text">å…ˆå®Œæˆæ­¥é©Ÿ 2ï¼Œç„¶å¾Œé»æ“Šã€Œè½‰æ›ç‚º sb.append()ã€</div>';
                    updateStatus(3, 'empty');
                    break;
                case 4:
                    document.getElementById('hibernateOutput').innerHTML = '<div class="placeholder-text">å‹¾é¸ã€Œç”¢ç”Ÿ HibernateScalarHelperã€é¸é …ï¼Œç„¶å¾ŒåŸ·è¡Œæ­¥é©Ÿ 3</div>';
                    updateStatus(4, 'empty');
                    break;
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ­¥é©Ÿ
        function clearAllSteps() {
            for (let i = 1; i <= 4; i++) {
                clearStep(i);
            }
            document.getElementById('camelCaseAsCheckbox').checked = false;
            document.getElementById('hibernateCheckbox').checked = false;
        }

        // ä¸€éµåŸ·è¡Œæ‰€æœ‰æ­¥é©Ÿ
        async function executeAllSteps() {
            const sql = document.getElementById('sqlInput').value.trim();
            
            if (!sql) {
                alert('è«‹å…ˆè¼¸å…¥ SQL èªå¥');
                return;
            }

            // æ­¥é©Ÿ 2: æ ¼å¼åŒ–
            await executePoorSqlFormat();
            
            // ç­‰å¾…ä¸€ä¸‹è®“ DOM æ›´æ–°
            setTimeout(() => {
                // æ­¥é©Ÿ 3: è½‰æ›
                convertToSbAppend();
                
                // å¦‚æœå‹¾é¸äº† HibernateScalarHelperï¼Œæœƒåœ¨ convertToSbAppend ä¸­è‡ªå‹•åŸ·è¡Œ
            }, 500);
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            let text;
            if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
                text = element.value;
            } else {
                text = element.textContent;
            }

            if (!text || text.includes('è«‹å…ˆåœ¨ä¸Šæ–¹') || text.includes('å…ˆå®Œæˆ') || text.includes('å‹¾é¸')) {
                alert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                // æ‰¾åˆ°å°æ‡‰çš„è¤‡è£½æŒ‰éˆ•ä¸¦é¡¯ç¤ºåé¥‹
                const copyBtn = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
                if (copyBtn) {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'âœ… å·²è¤‡è£½';
                    copyBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('copied');
                    }, 2000);
                }
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç›£è½æ ¼å¼åŒ–æ–¹å¼è®ŠåŒ–
            document.querySelectorAll('input[name="formatMethod"]').forEach(radio => {
                radio.addEventListener('change', handleFormatMethodChange);
            });
            
            // ç›£è½è¼¸å…¥æ¡†è®ŠåŒ–
            document.getElementById('sqlInput').addEventListener('input', function() {
                if (this.value.trim()) {
                    updateStatus(1, 'ready');
                } else {
                    updateStatus(1, 'empty');
                }
            });

            // åˆå§‹åŒ–é¡¯ç¤ºs
            handleFormatMethodChange();
        });
    </script>
</body>
</html>