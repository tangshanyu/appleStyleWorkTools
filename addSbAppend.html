<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL è½‰ Java sb.append() å·¥å…·</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="shared-navigation.js"></script>
    <script src="poorsql.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SQL è½‰ Java sb.append()</h1>
            <p>æ•´åˆæœ¬åœ° Poor SQL æ ¼å¼åŒ– + å››æ­¥é©Ÿè½‰æ›æµç¨‹</p>
        </div>
        
        <nav class="nav"></nav>
        
        <div class="content">
            <div class="form-group">
                <div class="component-header">
                    <h2>åŸå§‹ SQL è¼¸å…¥</h2>
                </div>
                <textarea id="sqlInput" class="form-control" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„åŸå§‹ SQL èªå¥..."></textarea>
                <div class="button-group">
                    <button class="btn theme-blue" onclick="loadTestSql()">ğŸ§ª è¼‰å…¥æ¸¬è©¦è³‡æ–™</button>
                </div>
            </div>

            <div class="form-group">
                <h2>ğŸ¯ SQL æ ¼å¼åŒ–æ–¹å¼é¸æ“‡</h2>
                <div class="format-options">
                    <label class="format-option active" id="option-local">
                        <input type="radio" name="formatMethod" value="local" checked>
                        <div><p>ğŸ—‚ï¸ æœ¬åœ° Poor SQL</p> <div style="font-size: 12px;">ä½¿ç”¨æœ¬åœ° poorsql.jsï¼ˆæ¨è–¦ï¼‰</div></div>
                    </label>
                    <label class="format-option" id="option-iframe">
                        <input type="radio" name="formatMethod" value="iframe">
                        <div><p>ğŸŒ Poor SQL ç¶²é </p> <div style="font-size: 12px;">åµŒå…¥å¼ç¶²é æ ¼å¼åŒ–</div></div>
                    </label>
                    <label class="format-option" id="option-manual">
                        <input type="radio" name="formatMethod" value="manual">
                        <div><p>âœ‹ æ‰‹å‹•è¼¸å…¥</p> <div style="font-size: 12px;">è‡ªè¡Œè™•ç†æ ¼å¼åŒ–</div></div>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <h2>âš™ï¸ å¾ŒçºŒè™•ç†é¸é …</h2>
                <div class="option-group">
                    <label class="format-option" for="camelCaseAsCheckbox">
                        <input type="checkbox" id="camelCaseAsCheckbox">
                        <span>ğŸª SELECT æ¬„ä½ä½¿ç”¨é§å³°å‘½å AS åˆ¥å</span>
                    </label>
                    <label class="format-option active" for="hibernateCheckbox">
                        <input type="checkbox" id="hibernateCheckbox" checked>
                        <span>ğŸ—ï¸ ç”¢ç”Ÿ HibernateScalarHelper</span>
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button class="btn theme-orange" onclick="executeAllSteps()">âš¡ åŸ·è¡Œæ‰€æœ‰æ­¥é©Ÿ</button>
                <button class="btn theme-green" onclick="executePoorSqlFormat()">ğŸ¨ åŸ·è¡Œ Poor SQL æ ¼å¼åŒ–</button>
                <button class="btn theme-red" onclick="clearAllSteps()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            </div>

            <hr style="border:none; border-top:var(--glass-border); margin: 24px 0;">

            <div class="form-group">
                <div class="component-header">
                    <h2>æ ¼å¼åŒ–å¾Œ SQL (Poor SQL)</h2>
                    <button class="btn theme-blue" onclick="copyToClipboard('formattedSql')">ğŸ“‹ è¤‡è£½</button>
                </div>
                <div id="formattedSql" class="output"><div class="placeholder-text">è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡æ ¼å¼åŒ–æ–¹å¼ä¸¦åŸ·è¡Œ Poor SQL æ ¼å¼åŒ–</div></div>
            </div>

            <div class="form-group">
                <div class="component-header">
                    <h2>sb.append() çµæœ</h2>
                    <button class="btn theme-blue" onclick="copyToClipboard('sbAppendOutput')">ğŸ“‹ è¤‡è£½</button>
                </div>
                <div id="sbAppendOutput" class="output"><div class="placeholder-text">å…ˆå®Œæˆæ­¥é©Ÿ 2ï¼Œç„¶å¾Œé»æ“Šã€Œè½‰æ›ç‚º sb.append()ã€</div></div>
            </div>

            <div class="form-group">
                <div class="component-header">
                    <h2>HibernateScalarHelper</h2>
                    <button class="btn theme-blue" onclick="copyToClipboard('hibernateOutput')">ğŸ“‹ è¤‡è£½</button>
                </div>
                <div id="hibernateOutput" class="output"><div class="placeholder-text">å‹¾é¸ã€Œç”¢ç”Ÿ HibernateScalarHelperã€é¸é …ï¼Œç„¶å¾ŒåŸ·è¡Œæ­¥é©Ÿ 3</div></div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¬è©¦ç”¨ SQL
        const TEST_SQL = `SELECT CB_DTA.CONTR_NO, CB_DTA.SELL_DEAL_ACC_DATE, CB_DTA.SELL_VLU_ACC_DATE, CB_DTA.SELL_SETT_ACC_DATE, CB_DTA.STCURR, CB_DTA.FIN_ASET_CTG_OPT_CTG, CB_DTA.FIN_ASET_CTG, CB_DTA.ACC_CTG, e.ACC_BASE, e.EVCURR, e.BIZ_CTG_1, f.TAX_FREE_MARK, e.BSCURR_FEXG_TYP, e.FEXG_TYP, e.NO_DIRRATE_YN_USE_CROSSRATE, t.CURR_DCML_LSD, SUM(CB_DTA.SELL_COST) AS TOT_SELL_COST, SUM(CB_DTA.SELL_DEAL_AMT) AS TOT_SELL_DEAL_AMT, SUM(CB_DTA.SELL_SETT_AMT) AS TOT_SELL_SETT_AMT FROM ( SELECT '1202-3000' AS ACC_PRD_COMB, ad.CONTR_NO, ad.ACC_CTG, ad.SELL_DEAL_DATE, ad.SELL_DEAL_ACC_DATE, ad.SELL_SETT_DATE, ad.SELL_SETT_ACC_DATE, ad.SELL_VLU_DATE, ad.SELL_VLU_ACC_DATE, ad.STCURR, ad.FIN_ASET_CTG_OPT_CTG, ad.FIN_ASET_CTG FROM AM_TX_SELL_CB ad WHERE ad.CONTR_NO IN ('Parm1') AND ad.FIN_ASET_CTG = '01' ) CB_DTA JOIN AM_C_MST e ON CB_DTA.CONTR_NO = e.CONTR_NO JOIN AM_C_SUB_CB f ON e.CONTR_NO = f.CONTR_NO JOIN COMM_CURR t ON t.CURR_CDE = e.EVCURR GROUP BY CB_DTA.CONTR_NO, CB_DTA.FIN_ASET_CTG_OPT_CTG ORDER BY CB_DTA.CONTR_NO, CB_DTA.FIN_ASET_CTG_OPT_CTG`;

        // æ ¼å¼åŒ–æ–¹å¼åˆ‡æ›
        function handleFormatMethodChange() {
            const selectedMethod = document.querySelector('input[name="formatMethod"]:checked').value;
            const iframeContainer = document.getElementById('iframe-container');
            const localSection = document.getElementById('local-section');
            const getFromPoorSqlBtn = document.getElementById('get-from-poorsql-btn');
            
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById(`option-${selectedMethod}`).classList.add('active');
            
            if (selectedMethod === 'iframe') {
                if(iframeContainer) iframeContainer.style.display = 'block';
                if(localSection) localSection.style.display = 'none';
                if(getFromPoorSqlBtn) getFromPoorSqlBtn.style.display = 'inline-flex';
            } else {
                if(iframeContainer) iframeContainer.style.display = 'none';
                if(localSection) localSection.style.display = 'block';
                if(getFromPoorSqlBtn) getFromPoorSqlBtn.style.display = 'none';
            }
        }

        async function executePoorSqlFormat() {
            const sql = document.getElementById('sqlInput').value.trim();
            if (!sql) { alert('è«‹å…ˆè¼¸å…¥ SQL èªå¥'); return; }

            const selectedMethod = document.querySelector('input[name="formatMethod"]:checked').value;
            if (selectedMethod === 'manual') {
                document.getElementById('formattedSql').textContent = sql;
                return sql;
            }

            try {
                if (typeof PoorMansTSqlFormatterLib === 'undefined') throw new Error('Poor SQL åº«æœªæ­£ç¢ºè¼‰å…¥');
                const formatter = new PoorMansTSqlFormatterLib.Formatters.TSqlStandardFormatter();
                formatter.IndentString = '\t';
                formatter.MaxLineWidth = 999;
                const parser = new PoorMansTSqlFormatterLib.Parsers.TSqlStandardParser();
                const tokenizer = new PoorMansTSqlFormatterLib.Tokenizers.TSqlStandardTokenizer();
                const formattedSql = formatter.FormatSQLTree(parser.ParseSQL(tokenizer.TokenizeSQL(sql)));
                document.getElementById('formattedSql').textContent = formattedSql;
                return formattedSql;
            } catch (error) {
                console.error('æ ¼å¼åŒ–å¤±æ•—:', error);
                document.getElementById('formattedSql').textContent = sql;
                return sql;
            }
        }

        function loadTestSql() {
            document.getElementById('sqlInput').value = TEST_SQL;
        }

        function addCamelCaseAS(sql) {
            const toCamelCase = (str) => {
                return str.toLowerCase().split('_').map((word, index) => {
                    if (index === 0) return word;
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }).join('');
            };
            const selectClauseRegex = /(\bSELECT\b)([\s\S]+?)(\bFROM\b)/i;
            const match = sql.match(selectClauseRegex);
            if (!match) return sql;
            const fieldsString = match[2];
            const processedFields = fieldsString.split(',').map(field => {
                const trimmedField = field.trim();
                if (trimmedField.toUpperCase().includes(' AS ') || !trimmedField.includes('.')) return field;
                const parts = trimmedField.split('.');
                const columnName = parts[parts.length - 1];
                if (columnName.includes('_')) {
                    const alias = toCamelCase(columnName);
                    return field.replace(trimmedField, `${trimmedField} AS ${alias}`);
                }
                return field;
            }).join(',');
            return sql.replace(fieldsString, processedFields);
        }

        function generateHibernateHelperFromSql(sql) {
            try {
                const selectMatch = sql.match(/\bSELECT\s+([\s\S]+?)(?:\s+FROM\b|\s+INTO\b|\s*$)/i);
                if (!selectMatch) throw new Error("ç„¡æ³•è­˜åˆ¥ SELECT èªå¥");
                const fields = selectMatch[1].split(',').map(f => {
                    const cleanField = f.replace(/--.*$/, '').trim();
                    const asMatch = cleanField.match(/\s+AS\s+(\w+)/i);
                    if (asMatch) return asMatch[1];
                    let fieldName = cleanField.includes('.') ? cleanField.split('.').pop() : cleanField;
                    return fieldName.replace(/[^\w]/g, '');
                }).filter(Boolean);
                if (fields.length > 0) {
                    const hibernateList = fields.map(f => `scalarList.add(new HibernateScalarHelper("${f}", StandardBasicTypes.STRING));`).join('\n');
                    document.getElementById('hibernateOutput').textContent = `List<HibernateScalarHelper> scalarList = new ArrayList<>();\n${hibernateList}`;
                } else { throw new Error("ç„¡æ³•æå–åˆ°æœ‰æ•ˆçš„æ¬„ä½å"); }
            } catch (error) {
                document.getElementById('hibernateOutput').innerHTML = `<div class="placeholder-text">${error.message}</div>`;
            }
        }

        async function executeAllSteps() {
            const formattedSql = await executePoorSqlFormat();
            if (!formattedSql) return;
            const sqlWithAliases = convertToSbAppend(formattedSql);
            if (document.getElementById('hibernateCheckbox').checked) {
                generateHibernateHelperFromSql(sqlWithAliases);
            }
        }

        function convertToSbAppend(sql) {
            if (!sql) return;
            const sqlToProcess = document.getElementById('camelCaseAsCheckbox').checked ? addCamelCaseAS(sql) : sql;
            const lines = sqlToProcess.split('\n').map(line => {
                if (!line.trim()) return null;
                const escapedCode = line.replace(/"/g, '\"').trim();
                const originalIndent = line.match(/^(\s*)/)[1] || "";
                return `sb.append(" ${originalIndent}${escapedCode} ");`;
            }).filter(Boolean);
            document.getElementById('sbAppendOutput').textContent = lines.join('\n');
            return sqlToProcess;
        }

        function clearAllSteps() {
            document.getElementById('sqlInput').value = '';
            ['formattedSql', 'sbAppendOutput', 'hibernateOutput'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="placeholder-text">çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</div>';
            });
            document.getElementById('camelCaseAsCheckbox').checked = false;
            document.getElementById('hibernateCheckbox').checked = true;
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            if (!el || !el.textContent || el.textContent.includes('è«‹å…ˆ')) return alert('æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹');
            navigator.clipboard.writeText(el.textContent).then(() => {
                const btn = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
                if(btn) { const old = btn.innerHTML; btn.innerHTML = 'âœ… å·²è¤‡è£½'; setTimeout(()=> btn.innerHTML = old, 2000); }
            }).catch(err => alert('è¤‡è£½å¤±æ•—'));
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSharedNavigation();
            document.querySelectorAll('input[name="formatMethod"]').forEach(radio => {
                radio.addEventListener('change', handleFormatMethodChange);
            });
            handleFormatMethodChange();

            // New logic for checkbox active state
            document.querySelectorAll('.option-group input[type="checkbox"]').forEach(checkbox => {
                const parentLabel = checkbox.closest('.format-option');
                if (!parentLabel) return;

                // Set initial state
                if (checkbox.checked) {
                    parentLabel.classList.add('active');
                }

                // Add change listener
                checkbox.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        parentLabel.classList.add('active');
                    } else {
                        parentLabel.classList.remove('active');
                    }
                });
            });
        });
    </script>
</body>
</html>