<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL 轉 Java sb.append() 工具</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <div class="container">
        <div class="header theme-orange">
            <h1>SQL 轉 Java sb.append()</h1>
            <p>將 SQL 語句轉換為 Java StringBuilder.append() 格式，支援註釋處理與排版優化</p>
        </div>
        
        <nav class="nav">
            <a href="index.html">🏠 回首頁</a>
            <a href="putSpecSql.html">🔧 參數替換</a>
            <a href="changeQuestionMark.html">❓ 問號轉換</a>
        </nav>
        
        <div class="content">
            <div class="alert alert-info">
                <strong>✨ 使用說明：</strong>
                輸入 SQL 語句，工具會自動處理所有行的排版、註釋移動和駝峰命名轉換。HibernateScalarHelper 會根據是否勾選駝峰選項決定使用原始欄位名或 AS 別名。
                <div class="example">
                    <strong>轉換範例：</strong>
不勾選駝峰：
SELECT a.CONTR_NO, b.USER_ID, c.AM_C_MST
→ HibernateScalarHelper 使用原始欄位名：CONTR_NO, USER_ID, AM_C_MST

勾選駝峰：
SELECT a.CONTR_NO AS contrNo, b.USER_ID AS userId, c.AM_C_MST AS amCMst
→ HibernateScalarHelper 使用 AS 別名：contrNo, userId, amCMst

<strong>注意：nam 相關欄位不會進行駝峰轉換</strong>
                </div>
            </div>
            
            <div class="form-group">
                <label for="sqlInput">📝 輸入 SQL：</label>
                <textarea id="sqlInput" class="form-control" placeholder="請輸入 SQL 語句，支援 -- 和 /* */ 註釋..." rows="12"></textarea>
            </div>
            
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="camelCaseAsCheckbox">
                    <label for="camelCaseAsCheckbox">🐪 SELECT 欄位使用駝峰命名 AS 別名（排除 nam 相關欄位）</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="hibernateCheckbox">
                    <label for="hibernateCheckbox">🏗️ 產生 HibernateScalarHelper</label>
                </div>
            </div>
            
            <div class="button-group">
                <button id="convertSqlBtn" class="btn theme-orange">🚀 轉換</button>
            </div>
            
            <div class="results-layout">
                <div class="output-section">
                    <div class="form-group">
                        <label>⚡ sb.append() 結果：</label>
                        <div id="sbAppendOutput" class="output">sb.append() 結果將在這裡顯示...</div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success copy-button" data-copy-target="sbAppendOutput">📋 複製</button>
                    </div>
                </div>
                
                <div class="output-section">
                    <div class="form-group">
                        <label>🏗️ HibernateScalarHelper List：</label>
                        <div id="hibernateOutput" class="output">HibernateScalarHelper 結果將在這裡顯示...</div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success copy-button" data-copy-target="hibernateOutput">📋 複製</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        function initializeAddSbAppendTool() {
            const convertBtn = document.getElementById('convertSqlBtn');
            const copyButtons = document.querySelectorAll('.copy-button');
            
            if (convertBtn) convertBtn.addEventListener('click', convertSql);
            
            copyButtons.forEach(button => {
                const targetId = button.dataset.copyTarget;
                if (targetId) {
                    button.addEventListener('click', () => copyToClipboard(targetId));
                }
            });
        }

        // 將底線分隔的字段名轉換為駝峰式命名
        function toCamelCase(str) {
            return str.split('_').map((word, index) => {
                if (index === 0) {
                    return word.toLowerCase();
                }
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join('');
        }

        // 檢查是否為 nam 相關欄位
        function isNamField(fieldName) {
            const lowerFieldName = fieldName.toLowerCase();
            return lowerFieldName.includes('nam') || 
                   lowerFieldName.includes('name') ||
                   lowerFieldName.startsWith('nam_') ||
                   lowerFieldName.endsWith('_nam') ||
                   lowerFieldName.startsWith('name_') ||
                   lowerFieldName.endsWith('_name');
        }

        // 提取並處理註釋 - 適用於所有行
        function extractComments(line) {
            const result = {
                code: line,
                comment: null,
                commentType: null
            };

            // 處理 -- 註釋
            const singleLineCommentMatch = line.match(/^(.*?)--(.*)$/);
            if (singleLineCommentMatch) {
                result.code = singleLineCommentMatch[1].trimEnd();
                result.comment = singleLineCommentMatch[2].trim();
                result.commentType = 'single';
                return result;
            }

            // 處理 /* */ 註釋
            const blockCommentMatch = line.match(/^(.*?)\/\*(.*?)\*\/(.*)$/);
            if (blockCommentMatch) {
                result.code = (blockCommentMatch[1] + blockCommentMatch[3]).trim();
                result.comment = blockCommentMatch[2].trim();
                result.commentType = 'block';
                return result;
            }

            return result;
        }

        // 計算行的縮排空格數（tab = 4 spaces）
        function getIndentation(line) {
            const match = line.match(/^(\s*)/);
            if (!match) return '';
            
            const indent = match[1];
            // 將 tab 轉換為 4 個空格
            return indent.replace(/\t/g, '    ');
        }

        // 解析完整的 SELECT 語句，支援多行和複雜結構
        function parseSelectFields(sql) {
            try {
                // 移除所有註釋以便正確解析
                let cleanSql = sql.replace(/--.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, '');
                
                // 找到 SELECT 和 FROM 的位置（不區分大小寫）
                const selectMatch = cleanSql.match(/\bSELECT\s+/i);
                const fromMatch = cleanSql.match(/\s+FROM\s+/i);
                
                if (!selectMatch || !fromMatch) {
                    console.log('無法找到 SELECT 或 FROM 關鍵字');
                    return [];
                }
                
                const selectStart = selectMatch.index + selectMatch[0].length;
                const fromStart = fromMatch.index;
                
                if (selectStart >= fromStart) {
                    console.log('SELECT 和 FROM 位置錯誤');
                    return [];
                }
                
                // 提取 SELECT 和 FROM 之間的內容
                const fieldsText = cleanSql.substring(selectStart, fromStart).trim();
                
                console.log('提取的欄位文本:', fieldsText);
                
                // 分割欄位，考慮括號內的逗號
                const fields = [];
                let currentField = '';
                let parenthesesLevel = 0;
                
                for (let i = 0; i < fieldsText.length; i++) {
                    const char = fieldsText[i];
                    
                    if (char === '(') {
                        parenthesesLevel++;
                        currentField += char;
                    } else if (char === ')') {
                        parenthesesLevel--;
                        currentField += char;
                    } else if (char === ',' && parenthesesLevel === 0) {
                        // 找到欄位分隔符
                        if (currentField.trim()) {
                            fields.push(currentField.trim());
                        }
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                
                // 加入最後一個欄位
                if (currentField.trim()) {
                    fields.push(currentField.trim());
                }
                
                console.log('分割後的欄位:', fields);
                return fields;
            } catch (error) {
                console.error('解析 SELECT 欄位時發生錯誤:', error);
                return [];
            }
        }

        function convertSql() {
            const sql = document.getElementById("sqlInput")?.value || "";
            const useCamelCaseAs = document.getElementById('camelCaseAsCheckbox')?.checked || false;
            const generateHibernate = document.getElementById('hibernateCheckbox')?.checked || false;
            
            if (!sql.trim()) {
                alert("請輸入 SQL 語句");
                return;
            }
            
            // 處理 SQL 語句
            let processedSql = sql;
            
            // 如果啟用駝峰命名 AS 別名，處理 SELECT 欄位
            if (useCamelCaseAs) {
                // 使用更精確的方式處理多行 SELECT，但保持原有的行結構
                const lines = processedSql.split('\n');
                const processedLines = lines.map(line => {
                    const trimmedLine = line.trim();
                    
                    // 只處理包含 SELECT 欄位的行
                    if (trimmedLine.toUpperCase().startsWith('SELECT ') || 
                        (trimmedLine.startsWith(',') && !trimmedLine.toUpperCase().includes('FROM'))) {
                        
                        const commentInfo = extractComments(line);
                        let codePart = commentInfo.code;
                        
                        // 獲取原始縮排
                        const indent = getIndentation(line);
                        const cleanCode = codePart.trim();
                        
                        // 處理欄位
                        let processedCode = cleanCode;
                        
                        // 移除 SELECT 關鍵字（如果存在）
                        const selectRemoved = processedCode.replace(/^SELECT\s+/i, '');
                        const isSelectLine = processedCode !== selectRemoved;
                        
                        // 移除開頭的逗號（如果存在）
                        const commaRemoved = selectRemoved.replace(/^,\s*/, '');
                        const hasComma = selectRemoved !== commaRemoved;
                        
                        const fieldPart = commaRemoved;
                        
                        // 如果已經有 AS 別名，就不處理
                        if (!fieldPart.toUpperCase().includes(' AS ') && fieldPart.trim() !== '') {
                            // 提取欄位名（移除表名前綴）
                            let fieldName = fieldPart;
                            if (fieldPart.includes('.')) {
                                const parts = fieldPart.split('.');
                                fieldName = parts[parts.length - 1];
                            }
                            
                            // 移除函數包裝，例如 COUNT(AM_C_MST) -> AM_C_MST
                            const functionMatch = fieldName.match(/(\w+)\s*\(\s*([^)]+)\s*\)/);
                            if (functionMatch) {
                                fieldName = functionMatch[2].trim();
                                if (fieldName.includes('.')) {
                                    fieldName = fieldName.split('.').pop();
                                }
                            }
                            
                            // 移除多餘的空白和特殊字符
                            fieldName = fieldName.replace(/[^\w]/g, '');
                            
                            // 檢查是否為 nam 相關欄位
                            if (!isNamField(fieldName) && fieldName.includes('_')) {
                                const camelCaseName = toCamelCase(fieldName);
                                processedCode = (isSelectLine ? 'SELECT ' : '') + 
                                               (hasComma ? ', ' : '') + 
                                               `${fieldPart} AS ${camelCaseName}`;
                            }
                        }
                        
                        // 重建行
                        let result = indent + processedCode;
                        
                        // 如果有註釋，添加回去
                        if (commentInfo.comment) {
                            if (commentInfo.commentType === 'single') {
                                result += ` --${commentInfo.comment}`;
                            } else if (commentInfo.commentType === 'block') {
                                result += ` /* ${commentInfo.comment} */`;
                            }
                        }
                        
                        return result;
                    }
                    
                    return line; // 不是 SELECT 欄位行就保持原樣
                });
                
                processedSql = processedLines.join('\n');
            }
            
            // 轉換為 sb.append() 格式 - 處理所有行的註釋
            const lines = processedSql.split('\n');
            const sbAppendResult = lines.map(line => {
                if (!line.trim()) return '';
                
                // 提取註釋 - 對所有行都進行處理
                const commentInfo = extractComments(line);
                const code = commentInfo.code;
                const comment = commentInfo.comment;
                const commentType = commentInfo.commentType;
                
                // 獲取原始縮排
                const indent = getIndentation(line);
                
                // 移除原始縮排，保持內容
                const cleanCode = code.trim();
                
                if (cleanCode) {
                    // 轉換單引號
                    const escapedCode = cleanCode.replace(/'/g, "''");
                    
                    // 組成 sb.append() 語句，前後各加一個空格
                    let appendStatement = `sb.append("${indent} ${escapedCode} ");`;
                    
                    // 如果有註釋，添加到後面
                    if (comment) {
                        if (commentType === 'single') {
                            appendStatement += ` //${comment}`;
                        } else if (commentType === 'block') {
                            appendStatement += ` /* ${comment} */`;
                        }
                    }
                    
                    return appendStatement;
                }
                return '';
            }).filter(line => line).join('\n');
            
            // 更新結果
            const sbOutput = document.getElementById("sbAppendOutput");
            if (sbOutput) {
                sbOutput.textContent = sbAppendResult;
            }
            
            // 如果需要生成 HibernateScalarHelper
            if (generateHibernate) {
                generateHibernateHelper(processedSql, useCamelCaseAs);
            } else {
                const hibernateOutput = document.getElementById("hibernateOutput");
                if (hibernateOutput) {
                    hibernateOutput.textContent = "請勾選「產生 HibernateScalarHelper」選項";
                }
            }
        }

        function generateHibernateHelper(sql, useCamelCaseAs) {
            try {
                console.log('開始生成 HibernateScalarHelper，SQL:', sql);
                console.log('是否使用駝峰命名:', useCamelCaseAs);
                
                // 使用新的解析方法
                const selectFields = parseSelectFields(sql);
                
                if (selectFields.length === 0) {
                    const hibernateOutput = document.getElementById("hibernateOutput");
                    if (hibernateOutput) {
                        hibernateOutput.textContent = "無法識別 SELECT 語句，請檢查 SQL 格式";
                    }
                    return;
                }
                
                const fields = selectFields.map(field => {
                    const trimmed = field.trim();
                    
                    console.log('處理欄位:', trimmed);
                    
                    // 先移除註釋
                    const commentInfo = extractComments(trimmed);
                    const cleanField = commentInfo.code.trim();
                    
                    // 檢查是否有 AS 別名
                    const asMatch = cleanField.match(/\s+AS\s+(\w+)/i);
                    if (asMatch) {
                        const aliasName = asMatch[1];
                        console.log('找到 AS 別名:', aliasName);
                        return aliasName;
                    }
                    
                    // 如果沒有 AS 別名，則根據駝峰選項決定處理方式
                    // 提取欄位名（移除表名前綴和函數）
                    let fieldName = cleanField;
                    
                    // 處理函數，例如 COUNT(AM_C_MST) -> AM_C_MST
                    const functionMatch = fieldName.match(/(\w+)\s*\(\s*([^)]+)\s*\)/);
                    if (functionMatch) {
                        fieldName = functionMatch[2].trim();
                        console.log('提取函數內容:', fieldName);
                    }
                    
                    // 移除表名前綴
                    if (fieldName.includes('.')) {
                        fieldName = fieldName.split('.').pop();
                        console.log('移除表名前綴後:', fieldName);
                    }
                    
                    // 移除多餘字符，只保留字母數字和底線
                    fieldName = fieldName.replace(/[^\w]/g, '');
                    
                    // 根據駝峰選項決定是否轉換
                    if (useCamelCaseAs && !isNamField(fieldName) && fieldName.includes('_')) {
                        const camelCaseName = toCamelCase(fieldName);
                        console.log('轉換為駝峰式命名:', fieldName, '->', camelCaseName);
                        return camelCaseName;
                    }
                    
                    // 如果不使用駝峰或是 nam 相關欄位，返回原始欄位名
                    console.log('使用原始欄位名:', fieldName);
                    return fieldName;
                }).filter(field => field && field.trim() !== '');
                
                console.log('所有處理後的欄位:', fields);
                
                if (fields.length > 0) {
                    // 生成 HibernateScalarHelper List 格式
                    const hibernateList = fields.map(field => 
                        `scalarList.add(new HibernateScalarHelper("${field}", StandardBasicTypes.STRING));`
                    ).join('\n');
                    
                    const hibernateResult = `List<HibernateScalarHelper> scalarList = new ArrayList<>();\n${hibernateList}`;
                    
                    const hibernateOutput = document.getElementById("hibernateOutput");
                    if (hibernateOutput) {
                        hibernateOutput.textContent = hibernateResult;
                    }
                    
                    console.log('生成的 Hibernate 結果:', hibernateResult);
                } else {
                    const hibernateOutput = document.getElementById("hibernateOutput");
                    if (hibernateOutput) {
                        hibernateOutput.textContent = "無法提取到有效的欄位名";
                    }
                }
            } catch (error) {
                console.error('生成 HibernateScalarHelper 時發生錯誤:', error);
                const hibernateOutput = document.getElementById("hibernateOutput");
                if (hibernateOutput) {
                    hibernateOutput.textContent = "生成 HibernateScalarHelper 時發生錯誤：" + error.message;
                }
            }
        }

        function copyToClipboard(id) {
            const element = document.getElementById(id);
            if (element) {
                const text = element.textContent;
                if (text && !text.includes("將在這裡顯示") && !text.includes("請勾選")) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            // 更好的複製成功提示
                            const btn = document.querySelector(`[data-copy-target="${id}"]`);
                            const originalText = btn.textContent;
                            btn.textContent = '✅ 已複製！';
                            btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';
                            
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.style.background = '';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('複製失敗:', err);
                            alert("複製失敗，請手動複製");
                        });
                } else {
                    alert("沒有可複製的內容");
                }
            }
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeAddSbAppendTool();
        });
    </script>
</body>
</html>