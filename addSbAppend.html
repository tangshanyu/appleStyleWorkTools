<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL 轉 Java sb.append() 工具</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="shared-navigation.js"></script>
    <script src="poorsql.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SQL 轉 Java sb.append()</h1>
            <p>整合本地 Poor SQL 格式化 + 四步驟轉換流程</p>
        </div>
        
        <nav class="nav"></nav>
        
        <div class="content">
            <div class="form-group">
                <div class="component-header">
                    <h2>原始 SQL 輸入</h2>
                </div>
                <textarea id="sqlInput" class="form-control" placeholder="請在此輸入您的原始 SQL 語句..."></textarea>
                <div class="button-group">
                    <button class="btn theme-blue" onclick="loadTestSql()">🧪 載入測試資料</button>
                </div>
            </div>

            <div class="form-group">
                <h2>🎯 SQL 格式化方式選擇</h2>
                <div class="format-options">
                    <label class="format-option active" id="option-local">
                        <input type="radio" name="formatMethod" value="local" checked>
                        <div><p>🗂️ 本地 Poor SQL</p> <div style="font-size: 12px;">使用本地 poorsql.js（推薦）</div></div>
                    </label>
                    <label class="format-option" id="option-iframe">
                        <input type="radio" name="formatMethod" value="iframe">
                        <div><p>🌐 Poor SQL 網頁</p> <div style="font-size: 12px;">嵌入式網頁格式化</div></div>
                    </label>
                    <label class="format-option" id="option-manual">
                        <input type="radio" name="formatMethod" value="manual">
                        <div><p>✋ 手動輸入</p> <div style="font-size: 12px;">自行處理格式化</div></div>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <h2>⚙️ 後續處理選項</h2>
                <div class="option-group">
                    <label class="format-option" for="camelCaseAsCheckbox">
                        <input type="checkbox" id="camelCaseAsCheckbox">
                        <span>🐪 SELECT 欄位使用駝峰命名 AS 別名</span>
                    </label>
                    <label class="format-option active" for="hibernateCheckbox">
                        <input type="checkbox" id="hibernateCheckbox" checked>
                        <span>🏗️ 產生 HibernateScalarHelper</span>
                    </label>
                </div>
            </div>

            <div class="button-group">
                <button class="btn theme-orange" onclick="executeAllSteps()">⚡ 執行所有步驟</button>
                <button class="btn theme-green" onclick="executePoorSqlFormat()">🎨 執行 Poor SQL 格式化</button>
                <button class="btn theme-red" onclick="clearAllSteps()">🗑️ 清空所有</button>
            </div>

            <hr style="border:none; border-top:var(--glass-border); margin: 24px 0;">

            <div class="form-group">
                <div class="component-header">
                    <h2>格式化後 SQL (Poor SQL)</h2>
                    <button class="btn theme-blue" onclick="copyToClipboard('formattedSql')">📋 複製</button>
                </div>
                <div id="formattedSql" class="output"><div class="placeholder-text">請先在上方選擇格式化方式並執行 Poor SQL 格式化</div></div>
            </div>

            <div class="form-group">
                <div class="component-header">
                    <h2>sb.append() 結果</h2>
                    <button class="btn theme-blue" onclick="copyToClipboard('sbAppendOutput')">📋 複製</button>
                </div>
                <div id="sbAppendOutput" class="output"><div class="placeholder-text">先完成步驟 2，然後點擊「轉換為 sb.append()」</div></div>
            </div>

            <div class="form-group">
                <div class="component-header">
                    <h2>HibernateScalarHelper</h2>
                    <button class="btn theme-blue" onclick="copyToClipboard('hibernateOutput')">📋 複製</button>
                </div>
                <div id="hibernateOutput" class="output"><div class="placeholder-text">勾選「產生 HibernateScalarHelper」選項，然後執行步驟 3</div></div>
            </div>
        </div>
    </div>

    <script>
        // 測試用 SQL
        const TEST_SQL = `SELECT CB_DTA.CONTR_NO, CB_DTA.SELL_DEAL_ACC_DATE, CB_DTA.SELL_VLU_ACC_DATE, CB_DTA.SELL_SETT_ACC_DATE, CB_DTA.STCURR, CB_DTA.FIN_ASET_CTG_OPT_CTG, CB_DTA.FIN_ASET_CTG, CB_DTA.ACC_CTG, e.ACC_BASE, e.EVCURR, e.BIZ_CTG_1, f.TAX_FREE_MARK, e.BSCURR_FEXG_TYP, e.FEXG_TYP, e.NO_DIRRATE_YN_USE_CROSSRATE, t.CURR_DCML_LSD, SUM(CB_DTA.SELL_COST) AS TOT_SELL_COST, SUM(CB_DTA.SELL_DEAL_AMT) AS TOT_SELL_DEAL_AMT, SUM(CB_DTA.SELL_SETT_AMT) AS TOT_SELL_SETT_AMT FROM ( SELECT '1202-3000' AS ACC_PRD_COMB, ad.CONTR_NO, ad.ACC_CTG, ad.SELL_DEAL_DATE, ad.SELL_DEAL_ACC_DATE, ad.SELL_SETT_DATE, ad.SELL_SETT_ACC_DATE, ad.SELL_VLU_DATE, ad.SELL_VLU_ACC_DATE, ad.STCURR, ad.FIN_ASET_CTG_OPT_CTG, ad.FIN_ASET_CTG FROM AM_TX_SELL_CB ad WHERE ad.CONTR_NO IN ('Parm1') AND ad.FIN_ASET_CTG = '01' ) CB_DTA JOIN AM_C_MST e ON CB_DTA.CONTR_NO = e.CONTR_NO JOIN AM_C_SUB_CB f ON e.CONTR_NO = f.CONTR_NO JOIN COMM_CURR t ON t.CURR_CDE = e.EVCURR GROUP BY CB_DTA.CONTR_NO, CB_DTA.FIN_ASET_CTG_OPT_CTG ORDER BY CB_DTA.CONTR_NO, CB_DTA.FIN_ASET_CTG_OPT_CTG`;

        // 格式化方式切換
        function handleFormatMethodChange() {
            const selectedMethod = document.querySelector('input[name="formatMethod"]:checked').value;
            const iframeContainer = document.getElementById('iframe-container');
            const localSection = document.getElementById('local-section');
            const getFromPoorSqlBtn = document.getElementById('get-from-poorsql-btn');
            
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('active');
            });
            document.getElementById(`option-${selectedMethod}`).classList.add('active');
            
            if (selectedMethod === 'iframe') {
                if(iframeContainer) iframeContainer.style.display = 'block';
                if(localSection) localSection.style.display = 'none';
                if(getFromPoorSqlBtn) getFromPoorSqlBtn.style.display = 'inline-flex';
            } else {
                if(iframeContainer) iframeContainer.style.display = 'none';
                if(localSection) localSection.style.display = 'block';
                if(getFromPoorSqlBtn) getFromPoorSqlBtn.style.display = 'none';
            }
        }

        async function executePoorSqlFormat() {
            const sql = document.getElementById('sqlInput').value.trim();
            if (!sql) { alert('請先輸入 SQL 語句'); return; }

            const selectedMethod = document.querySelector('input[name="formatMethod"]:checked').value;
            if (selectedMethod === 'manual') {
                document.getElementById('formattedSql').textContent = sql;
                return sql;
            }

            try {
                if (typeof PoorMansTSqlFormatterLib === 'undefined') throw new Error('Poor SQL 庫未正確載入');
                const formatter = new PoorMansTSqlFormatterLib.Formatters.TSqlStandardFormatter();
                formatter.IndentString = '\t';
                formatter.MaxLineWidth = 999;
                const parser = new PoorMansTSqlFormatterLib.Parsers.TSqlStandardParser();
                const tokenizer = new PoorMansTSqlFormatterLib.Tokenizers.TSqlStandardTokenizer();
                const formattedSql = formatter.FormatSQLTree(parser.ParseSQL(tokenizer.TokenizeSQL(sql)));
                document.getElementById('formattedSql').textContent = formattedSql;
                return formattedSql;
            } catch (error) {
                console.error('格式化失敗:', error);
                document.getElementById('formattedSql').textContent = sql;
                return sql;
            }
        }

        function loadTestSql() {
            document.getElementById('sqlInput').value = TEST_SQL;
        }

        function addCamelCaseAS(sql) {
            const toCamelCase = (str) => {
                return str.toLowerCase().split('_').map((word, index) => {
                    if (index === 0) return word;
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }).join('');
            };
            const selectClauseRegex = /(\bSELECT\b)([\s\S]+?)(\bFROM\b)/i;
            const match = sql.match(selectClauseRegex);
            if (!match) return sql;
            const fieldsString = match[2];
            const processedFields = fieldsString.split(',').map(field => {
                const trimmedField = field.trim();
                if (trimmedField.toUpperCase().includes(' AS ') || !trimmedField.includes('.')) return field;
                const parts = trimmedField.split('.');
                const columnName = parts[parts.length - 1];
                if (columnName.includes('_')) {
                    const alias = toCamelCase(columnName);
                    return field.replace(trimmedField, `${trimmedField} AS ${alias}`);
                }
                return field;
            }).join(',');
            return sql.replace(fieldsString, processedFields);
        }

        function generateHibernateHelperFromSql(sql) {
            try {
                const selectMatch = sql.match(/\bSELECT\s+([\s\S]+?)(?:\s+FROM\b|\s+INTO\b|\s*$)/i);
                if (!selectMatch) throw new Error("無法識別 SELECT 語句");
                const fields = selectMatch[1].split(',').map(f => {
                    const cleanField = f.replace(/--.*$/, '').trim();
                    const asMatch = cleanField.match(/\s+AS\s+(\w+)/i);
                    if (asMatch) return asMatch[1];
                    let fieldName = cleanField.includes('.') ? cleanField.split('.').pop() : cleanField;
                    return fieldName.replace(/[^\w]/g, '');
                }).filter(Boolean);
                if (fields.length > 0) {
                    const hibernateList = fields.map(f => `scalarList.add(new HibernateScalarHelper("${f}", StandardBasicTypes.STRING));`).join('\n');
                    document.getElementById('hibernateOutput').textContent = `List<HibernateScalarHelper> scalarList = new ArrayList<>();\n${hibernateList}`;
                } else { throw new Error("無法提取到有效的欄位名"); }
            } catch (error) {
                document.getElementById('hibernateOutput').innerHTML = `<div class="placeholder-text">${error.message}</div>`;
            }
        }

        async function executeAllSteps() {
            const formattedSql = await executePoorSqlFormat();
            if (!formattedSql) return;
            const sqlWithAliases = convertToSbAppend(formattedSql);
            if (document.getElementById('hibernateCheckbox').checked) {
                generateHibernateHelperFromSql(sqlWithAliases);
            }
        }

        function convertToSbAppend(sql) {
            if (!sql) return;
            const sqlToProcess = document.getElementById('camelCaseAsCheckbox').checked ? addCamelCaseAS(sql) : sql;
            const lines = sqlToProcess.split('\n').map(line => {
                if (!line.trim()) return null;
                const escapedCode = line.replace(/"/g, '\"').trim();
                const originalIndent = line.match(/^(\s*)/)[1] || "";
                return `sb.append(" ${originalIndent}${escapedCode} ");`;
            }).filter(Boolean);
            document.getElementById('sbAppendOutput').textContent = lines.join('\n');
            return sqlToProcess;
        }

        function clearAllSteps() {
            document.getElementById('sqlInput').value = '';
            ['formattedSql', 'sbAppendOutput', 'hibernateOutput'].forEach(id => {
                document.getElementById(id).innerHTML = '<div class="placeholder-text">結果將顯示於此</div>';
            });
            document.getElementById('camelCaseAsCheckbox').checked = false;
            document.getElementById('hibernateCheckbox').checked = true;
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            if (!el || !el.textContent || el.textContent.includes('請先')) return alert('沒有可複製的內容');
            navigator.clipboard.writeText(el.textContent).then(() => {
                const btn = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
                if(btn) { const old = btn.innerHTML; btn.innerHTML = '✅ 已複製'; setTimeout(()=> btn.innerHTML = old, 2000); }
            }).catch(err => alert('複製失敗'));
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadSharedNavigation();
            document.querySelectorAll('input[name="formatMethod"]').forEach(radio => {
                radio.addEventListener('change', handleFormatMethodChange);
            });
            handleFormatMethodChange();

            // New logic for checkbox active state
            document.querySelectorAll('.option-group input[type="checkbox"]').forEach(checkbox => {
                const parentLabel = checkbox.closest('.format-option');
                if (!parentLabel) return;

                // Set initial state
                if (checkbox.checked) {
                    parentLabel.classList.add('active');
                }

                // Add change listener
                checkbox.addEventListener('change', (event) => {
                    if (event.target.checked) {
                        parentLabel.classList.add('active');
                    } else {
                        parentLabel.classList.remove('active');
                    }
                });
            });
        });
    </script>
</body>
</html>