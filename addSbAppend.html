<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL è½‰ Java sb.append() å·¥å…·</title>
    <link rel="stylesheet" href="shared-styles.css">
</head>
<body>
    <div class="container">
        <div class="header theme-orange">
            <h1>SQL è½‰ Java sb.append()</h1>
            <p>å°‡ SQL èªå¥è½‰æ›ç‚º Java StringBuilder.append() æ ¼å¼ï¼Œæ”¯æ´è¨»é‡‹è™•ç†èˆ‡æ’ç‰ˆå„ªåŒ–</p>
        </div>
        
        <nav class="nav">
            <a href="index.html">ğŸ  å›é¦–é </a>
            <a href="putSpecSql.html">ğŸ”§ åƒæ•¸æ›¿æ›</a>
            <a href="changeQuestionMark.html">â“ å•è™Ÿè½‰æ›</a>
        </nav>
        
        <div class="content">
            <div class="alert alert-info">
                <strong>âœ¨ ä½¿ç”¨èªªæ˜ï¼š</strong>
                è¼¸å…¥ SQL èªå¥ï¼Œå·¥å…·æœƒè‡ªå‹•è™•ç†æ‰€æœ‰è¡Œçš„æ’ç‰ˆã€è¨»é‡‹ç§»å‹•å’Œé§å³°å‘½åè½‰æ›ã€‚HibernateScalarHelper æœƒæ ¹æ“šæ˜¯å¦å‹¾é¸é§å³°é¸é …æ±ºå®šä½¿ç”¨åŸå§‹æ¬„ä½åæˆ– AS åˆ¥åã€‚
                <div class="example">
                    <strong>è½‰æ›ç¯„ä¾‹ï¼š</strong>
ä¸å‹¾é¸é§å³°ï¼š
SELECT a.CONTR_NO, b.USER_ID, c.AM_C_MST
â†’ HibernateScalarHelper ä½¿ç”¨åŸå§‹æ¬„ä½åï¼šCONTR_NO, USER_ID, AM_C_MST

å‹¾é¸é§å³°ï¼š
SELECT a.CONTR_NO AS contrNo, b.USER_ID AS userId, c.AM_C_MST AS amCMst
â†’ HibernateScalarHelper ä½¿ç”¨ AS åˆ¥åï¼šcontrNo, userId, amCMst

<strong>æ³¨æ„ï¼šnam ç›¸é—œæ¬„ä½ä¸æœƒé€²è¡Œé§å³°è½‰æ›</strong>
                </div>
            </div>
            
            <div class="form-group">
                <label for="sqlInput">ğŸ“ è¼¸å…¥ SQLï¼š</label>
                <textarea id="sqlInput" class="form-control" placeholder="è«‹è¼¸å…¥ SQL èªå¥ï¼Œæ”¯æ´ -- å’Œ /* */ è¨»é‡‹..." rows="12"></textarea>
            </div>
            
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="camelCaseAsCheckbox">
                    <label for="camelCaseAsCheckbox">ğŸª SELECT æ¬„ä½ä½¿ç”¨é§å³°å‘½å AS åˆ¥åï¼ˆæ’é™¤ nam ç›¸é—œæ¬„ä½ï¼‰</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="hibernateCheckbox">
                    <label for="hibernateCheckbox">ğŸ—ï¸ ç”¢ç”Ÿ HibernateScalarHelper</label>
                </div>
            </div>
            
            <div class="button-group">
                <button id="convertSqlBtn" class="btn theme-orange">ğŸš€ è½‰æ›</button>
            </div>
            
            <div class="results-layout">
                <div class="output-section">
                    <div class="form-group">
                        <label>âš¡ sb.append() çµæœï¼š</label>
                        <div id="sbAppendOutput" class="output">sb.append() çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º...</div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success copy-button" data-copy-target="sbAppendOutput">ğŸ“‹ è¤‡è£½</button>
                    </div>
                </div>
                
                <div class="output-section">
                    <div class="form-group">
                        <label>ğŸ—ï¸ HibernateScalarHelper Listï¼š</label>
                        <div id="hibernateOutput" class="output">HibernateScalarHelper çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º...</div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success copy-button" data-copy-target="hibernateOutput">ğŸ“‹ è¤‡è£½</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        function initializeAddSbAppendTool() {
            const convertBtn = document.getElementById('convertSqlBtn');
            const copyButtons = document.querySelectorAll('.copy-button');
            
            if (convertBtn) convertBtn.addEventListener('click', convertSql);
            
            copyButtons.forEach(button => {
                const targetId = button.dataset.copyTarget;
                if (targetId) {
                    button.addEventListener('click', () => copyToClipboard(targetId));
                }
            });
        }

        // å°‡åº•ç·šåˆ†éš”çš„å­—æ®µåè½‰æ›ç‚ºé§å³°å¼å‘½å
        function toCamelCase(str) {
            return str.split('_').map((word, index) => {
                if (index === 0) {
                    return word.toLowerCase();
                }
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join('');
        }

        // æª¢æŸ¥æ˜¯å¦ç‚º nam ç›¸é—œæ¬„ä½
        function isNamField(fieldName) {
            const lowerFieldName = fieldName.toLowerCase();
            return lowerFieldName.includes('nam') || 
                   lowerFieldName.includes('name') ||
                   lowerFieldName.startsWith('nam_') ||
                   lowerFieldName.endsWith('_nam') ||
                   lowerFieldName.startsWith('name_') ||
                   lowerFieldName.endsWith('_name');
        }

        // æå–ä¸¦è™•ç†è¨»é‡‹ - é©ç”¨æ–¼æ‰€æœ‰è¡Œ
        function extractComments(line) {
            const result = {
                code: line,
                comment: null,
                commentType: null
            };

            // è™•ç† -- è¨»é‡‹
            const singleLineCommentMatch = line.match(/^(.*?)--(.*)$/);
            if (singleLineCommentMatch) {
                result.code = singleLineCommentMatch[1].trimEnd();
                result.comment = singleLineCommentMatch[2].trim();
                result.commentType = 'single';
                return result;
            }

            // è™•ç† /* */ è¨»é‡‹
            const blockCommentMatch = line.match(/^(.*?)\/\*(.*?)\*\/(.*)$/);
            if (blockCommentMatch) {
                result.code = (blockCommentMatch[1] + blockCommentMatch[3]).trim();
                result.comment = blockCommentMatch[2].trim();
                result.commentType = 'block';
                return result;
            }

            return result;
        }

        // è¨ˆç®—è¡Œçš„ç¸®æ’ç©ºæ ¼æ•¸ï¼ˆtab = 4 spacesï¼‰
        function getIndentation(line) {
            const match = line.match(/^(\s*)/);
            if (!match) return '';
            
            const indent = match[1];
            // å°‡ tab è½‰æ›ç‚º 4 å€‹ç©ºæ ¼
            return indent.replace(/\t/g, '    ');
        }

        // è§£æå®Œæ•´çš„ SELECT èªå¥ï¼Œæ”¯æ´å¤šè¡Œå’Œè¤‡é›œçµæ§‹
        function parseSelectFields(sql) {
            try {
                // ç§»é™¤æ‰€æœ‰è¨»é‡‹ä»¥ä¾¿æ­£ç¢ºè§£æ
                let cleanSql = sql.replace(/--.*$/gm, '').replace(/\/\*[\s\S]*?\*\//g, '');
                
                // æ‰¾åˆ° SELECT å’Œ FROM çš„ä½ç½®ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                const selectMatch = cleanSql.match(/\bSELECT\s+/i);
                const fromMatch = cleanSql.match(/\s+FROM\s+/i);
                
                if (!selectMatch || !fromMatch) {
                    console.log('ç„¡æ³•æ‰¾åˆ° SELECT æˆ– FROM é—œéµå­—');
                    return [];
                }
                
                const selectStart = selectMatch.index + selectMatch[0].length;
                const fromStart = fromMatch.index;
                
                if (selectStart >= fromStart) {
                    console.log('SELECT å’Œ FROM ä½ç½®éŒ¯èª¤');
                    return [];
                }
                
                // æå– SELECT å’Œ FROM ä¹‹é–“çš„å…§å®¹
                const fieldsText = cleanSql.substring(selectStart, fromStart).trim();
                
                console.log('æå–çš„æ¬„ä½æ–‡æœ¬:', fieldsText);
                
                // åˆ†å‰²æ¬„ä½ï¼Œè€ƒæ…®æ‹¬è™Ÿå…§çš„é€—è™Ÿ
                const fields = [];
                let currentField = '';
                let parenthesesLevel = 0;
                
                for (let i = 0; i < fieldsText.length; i++) {
                    const char = fieldsText[i];
                    
                    if (char === '(') {
                        parenthesesLevel++;
                        currentField += char;
                    } else if (char === ')') {
                        parenthesesLevel--;
                        currentField += char;
                    } else if (char === ',' && parenthesesLevel === 0) {
                        // æ‰¾åˆ°æ¬„ä½åˆ†éš”ç¬¦
                        if (currentField.trim()) {
                            fields.push(currentField.trim());
                        }
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                
                // åŠ å…¥æœ€å¾Œä¸€å€‹æ¬„ä½
                if (currentField.trim()) {
                    fields.push(currentField.trim());
                }
                
                console.log('åˆ†å‰²å¾Œçš„æ¬„ä½:', fields);
                return fields;
            } catch (error) {
                console.error('è§£æ SELECT æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                return [];
            }
        }

        function convertSql() {
            const sql = document.getElementById("sqlInput")?.value || "";
            const useCamelCaseAs = document.getElementById('camelCaseAsCheckbox')?.checked || false;
            const generateHibernate = document.getElementById('hibernateCheckbox')?.checked || false;
            
            if (!sql.trim()) {
                alert("è«‹è¼¸å…¥ SQL èªå¥");
                return;
            }
            
            // è™•ç† SQL èªå¥
            let processedSql = sql;
            
            // å¦‚æœå•Ÿç”¨é§å³°å‘½å AS åˆ¥åï¼Œè™•ç† SELECT æ¬„ä½
            if (useCamelCaseAs) {
                // ä½¿ç”¨æ›´ç²¾ç¢ºçš„æ–¹å¼è™•ç†å¤šè¡Œ SELECTï¼Œä½†ä¿æŒåŸæœ‰çš„è¡Œçµæ§‹
                const lines = processedSql.split('\n');
                const processedLines = lines.map(line => {
                    const trimmedLine = line.trim();
                    
                    // åªè™•ç†åŒ…å« SELECT æ¬„ä½çš„è¡Œ
                    if (trimmedLine.toUpperCase().startsWith('SELECT ') || 
                        (trimmedLine.startsWith(',') && !trimmedLine.toUpperCase().includes('FROM'))) {
                        
                        const commentInfo = extractComments(line);
                        let codePart = commentInfo.code;
                        
                        // ç²å–åŸå§‹ç¸®æ’
                        const indent = getIndentation(line);
                        const cleanCode = codePart.trim();
                        
                        // è™•ç†æ¬„ä½
                        let processedCode = cleanCode;
                        
                        // ç§»é™¤ SELECT é—œéµå­—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        const selectRemoved = processedCode.replace(/^SELECT\s+/i, '');
                        const isSelectLine = processedCode !== selectRemoved;
                        
                        // ç§»é™¤é–‹é ­çš„é€—è™Ÿï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        const commaRemoved = selectRemoved.replace(/^,\s*/, '');
                        const hasComma = selectRemoved !== commaRemoved;
                        
                        const fieldPart = commaRemoved;
                        
                        // å¦‚æœå·²ç¶“æœ‰ AS åˆ¥åï¼Œå°±ä¸è™•ç†
                        if (!fieldPart.toUpperCase().includes(' AS ') && fieldPart.trim() !== '') {
                            // æå–æ¬„ä½åï¼ˆç§»é™¤è¡¨åå‰ç¶´ï¼‰
                            let fieldName = fieldPart;
                            if (fieldPart.includes('.')) {
                                const parts = fieldPart.split('.');
                                fieldName = parts[parts.length - 1];
                            }
                            
                            // ç§»é™¤å‡½æ•¸åŒ…è£ï¼Œä¾‹å¦‚ COUNT(AM_C_MST) -> AM_C_MST
                            const functionMatch = fieldName.match(/(\w+)\s*\(\s*([^)]+)\s*\)/);
                            if (functionMatch) {
                                fieldName = functionMatch[2].trim();
                                if (fieldName.includes('.')) {
                                    fieldName = fieldName.split('.').pop();
                                }
                            }
                            
                            // ç§»é™¤å¤šé¤˜çš„ç©ºç™½å’Œç‰¹æ®Šå­—ç¬¦
                            fieldName = fieldName.replace(/[^\w]/g, '');
                            
                            // æª¢æŸ¥æ˜¯å¦ç‚º nam ç›¸é—œæ¬„ä½
                            if (!isNamField(fieldName) && fieldName.includes('_')) {
                                const camelCaseName = toCamelCase(fieldName);
                                processedCode = (isSelectLine ? 'SELECT ' : '') + 
                                               (hasComma ? ', ' : '') + 
                                               `${fieldPart} AS ${camelCaseName}`;
                            }
                        }
                        
                        // é‡å»ºè¡Œ
                        let result = indent + processedCode;
                        
                        // å¦‚æœæœ‰è¨»é‡‹ï¼Œæ·»åŠ å›å»
                        if (commentInfo.comment) {
                            if (commentInfo.commentType === 'single') {
                                result += ` --${commentInfo.comment}`;
                            } else if (commentInfo.commentType === 'block') {
                                result += ` /* ${commentInfo.comment} */`;
                            }
                        }
                        
                        return result;
                    }
                    
                    return line; // ä¸æ˜¯ SELECT æ¬„ä½è¡Œå°±ä¿æŒåŸæ¨£
                });
                
                processedSql = processedLines.join('\n');
            }
            
            // è½‰æ›ç‚º sb.append() æ ¼å¼ - è™•ç†æ‰€æœ‰è¡Œçš„è¨»é‡‹
            const lines = processedSql.split('\n');
            const sbAppendResult = lines.map(line => {
                if (!line.trim()) return '';
                
                // æå–è¨»é‡‹ - å°æ‰€æœ‰è¡Œéƒ½é€²è¡Œè™•ç†
                const commentInfo = extractComments(line);
                const code = commentInfo.code;
                const comment = commentInfo.comment;
                const commentType = commentInfo.commentType;
                
                // ç²å–åŸå§‹ç¸®æ’
                const indent = getIndentation(line);
                
                // ç§»é™¤åŸå§‹ç¸®æ’ï¼Œä¿æŒå…§å®¹
                const cleanCode = code.trim();
                
                if (cleanCode) {
                    // è½‰æ›å–®å¼•è™Ÿ
                    const escapedCode = cleanCode.replace(/'/g, "''");
                    
                    // çµ„æˆ sb.append() èªå¥ï¼Œå‰å¾Œå„åŠ ä¸€å€‹ç©ºæ ¼
                    let appendStatement = `sb.append("${indent} ${escapedCode} ");`;
                    
                    // å¦‚æœæœ‰è¨»é‡‹ï¼Œæ·»åŠ åˆ°å¾Œé¢
                    if (comment) {
                        if (commentType === 'single') {
                            appendStatement += ` //${comment}`;
                        } else if (commentType === 'block') {
                            appendStatement += ` /* ${comment} */`;
                        }
                    }
                    
                    return appendStatement;
                }
                return '';
            }).filter(line => line).join('\n');
            
            // æ›´æ–°çµæœ
            const sbOutput = document.getElementById("sbAppendOutput");
            if (sbOutput) {
                sbOutput.textContent = sbAppendResult;
            }
            
            // å¦‚æœéœ€è¦ç”Ÿæˆ HibernateScalarHelper
            if (generateHibernate) {
                generateHibernateHelper(processedSql, useCamelCaseAs);
            } else {
                const hibernateOutput = document.getElementById("hibernateOutput");
                if (hibernateOutput) {
                    hibernateOutput.textContent = "è«‹å‹¾é¸ã€Œç”¢ç”Ÿ HibernateScalarHelperã€é¸é …";
                }
            }
        }

        function generateHibernateHelper(sql, useCamelCaseAs) {
            try {
                console.log('é–‹å§‹ç”Ÿæˆ HibernateScalarHelperï¼ŒSQL:', sql);
                console.log('æ˜¯å¦ä½¿ç”¨é§å³°å‘½å:', useCamelCaseAs);
                
                // ä½¿ç”¨æ–°çš„è§£ææ–¹æ³•
                const selectFields = parseSelectFields(sql);
                
                if (selectFields.length === 0) {
                    const hibernateOutput = document.getElementById("hibernateOutput");
                    if (hibernateOutput) {
                        hibernateOutput.textContent = "ç„¡æ³•è­˜åˆ¥ SELECT èªå¥ï¼Œè«‹æª¢æŸ¥ SQL æ ¼å¼";
                    }
                    return;
                }
                
                const fields = selectFields.map(field => {
                    const trimmed = field.trim();
                    
                    console.log('è™•ç†æ¬„ä½:', trimmed);
                    
                    // å…ˆç§»é™¤è¨»é‡‹
                    const commentInfo = extractComments(trimmed);
                    const cleanField = commentInfo.code.trim();
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ AS åˆ¥å
                    const asMatch = cleanField.match(/\s+AS\s+(\w+)/i);
                    if (asMatch) {
                        const aliasName = asMatch[1];
                        console.log('æ‰¾åˆ° AS åˆ¥å:', aliasName);
                        return aliasName;
                    }
                    
                    // å¦‚æœæ²’æœ‰ AS åˆ¥åï¼Œå‰‡æ ¹æ“šé§å³°é¸é …æ±ºå®šè™•ç†æ–¹å¼
                    // æå–æ¬„ä½åï¼ˆç§»é™¤è¡¨åå‰ç¶´å’Œå‡½æ•¸ï¼‰
                    let fieldName = cleanField;
                    
                    // è™•ç†å‡½æ•¸ï¼Œä¾‹å¦‚ COUNT(AM_C_MST) -> AM_C_MST
                    const functionMatch = fieldName.match(/(\w+)\s*\(\s*([^)]+)\s*\)/);
                    if (functionMatch) {
                        fieldName = functionMatch[2].trim();
                        console.log('æå–å‡½æ•¸å…§å®¹:', fieldName);
                    }
                    
                    // ç§»é™¤è¡¨åå‰ç¶´
                    if (fieldName.includes('.')) {
                        fieldName = fieldName.split('.').pop();
                        console.log('ç§»é™¤è¡¨åå‰ç¶´å¾Œ:', fieldName);
                    }
                    
                    // ç§»é™¤å¤šé¤˜å­—ç¬¦ï¼Œåªä¿ç•™å­—æ¯æ•¸å­—å’Œåº•ç·š
                    fieldName = fieldName.replace(/[^\w]/g, '');
                    
                    // æ ¹æ“šé§å³°é¸é …æ±ºå®šæ˜¯å¦è½‰æ›
                    if (useCamelCaseAs && !isNamField(fieldName) && fieldName.includes('_')) {
                        const camelCaseName = toCamelCase(fieldName);
                        console.log('è½‰æ›ç‚ºé§å³°å¼å‘½å:', fieldName, '->', camelCaseName);
                        return camelCaseName;
                    }
                    
                    // å¦‚æœä¸ä½¿ç”¨é§å³°æˆ–æ˜¯ nam ç›¸é—œæ¬„ä½ï¼Œè¿”å›åŸå§‹æ¬„ä½å
                    console.log('ä½¿ç”¨åŸå§‹æ¬„ä½å:', fieldName);
                    return fieldName;
                }).filter(field => field && field.trim() !== '');
                
                console.log('æ‰€æœ‰è™•ç†å¾Œçš„æ¬„ä½:', fields);
                
                if (fields.length > 0) {
                    // ç”Ÿæˆ HibernateScalarHelper List æ ¼å¼
                    const hibernateList = fields.map(field => 
                        `scalarList.add(new HibernateScalarHelper("${field}", StandardBasicTypes.STRING));`
                    ).join('\n');
                    
                    const hibernateResult = `List<HibernateScalarHelper> scalarList = new ArrayList<>();\n${hibernateList}`;
                    
                    const hibernateOutput = document.getElementById("hibernateOutput");
                    if (hibernateOutput) {
                        hibernateOutput.textContent = hibernateResult;
                    }
                    
                    console.log('ç”Ÿæˆçš„ Hibernate çµæœ:', hibernateResult);
                } else {
                    const hibernateOutput = document.getElementById("hibernateOutput");
                    if (hibernateOutput) {
                        hibernateOutput.textContent = "ç„¡æ³•æå–åˆ°æœ‰æ•ˆçš„æ¬„ä½å";
                    }
                }
            } catch (error) {
                console.error('ç”Ÿæˆ HibernateScalarHelper æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                const hibernateOutput = document.getElementById("hibernateOutput");
                if (hibernateOutput) {
                    hibernateOutput.textContent = "ç”Ÿæˆ HibernateScalarHelper æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message;
                }
            }
        }

        function copyToClipboard(id) {
            const element = document.getElementById(id);
            if (element) {
                const text = element.textContent;
                if (text && !text.includes("å°‡åœ¨é€™è£¡é¡¯ç¤º") && !text.includes("è«‹å‹¾é¸")) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            // æ›´å¥½çš„è¤‡è£½æˆåŠŸæç¤º
                            const btn = document.querySelector(`[data-copy-target="${id}"]`);
                            const originalText = btn.textContent;
                            btn.textContent = 'âœ… å·²è¤‡è£½ï¼';
                            btn.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';
                            
                            setTimeout(() => {
                                btn.textContent = originalText;
                                btn.style.background = '';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('è¤‡è£½å¤±æ•—:', err);
                            alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½");
                        });
                } else {
                    alert("æ²’æœ‰å¯è¤‡è£½çš„å…§å®¹");
                }
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeAddSbAppendTool();
        });
    </script>
</body>
</html>